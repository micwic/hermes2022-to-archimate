---
description: "Sp√©cification des tests BDD pour le module hermes2022-concepts-site-extraction"
alwaysApply: true
---

# specification-hermes2022-concepts-site-extraction-tests.mdc: Sp√©cification des tests du module hermes2022-concepts-site-extraction

Chemin : hermes2022-to-archimate/hermes2022-concepts-site-extraction/__tests__/.cursor/rules/

> Cr√©√© le : 2025-10-26
> Derni√®re mise √† jour : 2025-11-09

## Description g√©n√©rale

- Les tests du module hermes2022-concepts-site-extraction sont √©crits selon l'approche Behavior-Driven Development (BDD) avec le langage Gherkin et le framework jest-cucumber
- Les tests sont organis√©s en deux cat√©gories distinctes : tests unitaires avec mocking des d√©pendances externes, et tests d'int√©gration avec appels API r√©els vers la plateforme SaaS NuExtract

## Contexte

- Framework de tests : Jest 30.0.5 avec jest-cucumber 4.5.0 pour l'ex√©cution des sc√©narios Gherkin
- Langage Gherkin : Fran√ßais (# language: fr) pour alignement avec sp√©cifications m√©tier
- Cycle BDD : Rouge ‚Üí Vert ‚Üí Refactor selon @bdd-governance
- Tests unitaires : Isolation des d√©pendances externes via mocking (fs, modules API)
- Tests d'int√©gration : Appels API r√©els vers plateforme SaaS NuExtract pour validation end-to-end
- Configuration Jest : Architecture monorepo standard avec jest.config.js racine orchestrant les configurations des modules

## Objectifs

- Garantir la conformit√© du code avec les sp√©cifications du module hermes2022-concepts-site-extraction
- Valider la gestion d'erreur robuste selon @error-handling-governance (messages explicites, Error Cause, terminaison "Script stopped")
- Assurer la validation de la structure des templates NuExtract (√©num√©rations converties, types NuExtract, r√©solution des $ref)
- V√©rifier la gestion du cycle de vie des projets NuExtract (cr√©ation, mise √† jour, recherche)
- Maintenir une s√©paration claire entre tests unitaires (comportement isol√©) et tests d'int√©gration (workflow complet)

## Principe : Sp√©cifications g√©n√©rales vs sp√©cifications d√©taill√©es

__Sp√©cifications g√©n√©rales__ (ce document) :

- D√©cisions architecturales et techniques justifi√©es
- Patterns valid√©s avec exemples minimalistes
- Anti-patterns avec solutions recommand√©es
- √âtat d'impl√©mentation

__Sp√©cifications d√©taill√©es__ (fichiers BDD) :

- `.feature` : Sc√©narios Gherkin exhaustifs (Given/When/Then)
- `.steps.ts` : Impl√©mentation compl√®te des steps avec mocking et assertions

__R√®gle__ : √âviter la redondance en documentant uniquement les d√©cisions et patterns dans les sp√©cifications g√©n√©rales, pas les sc√©narios d√©taill√©s d√©j√† pr√©sents dans `.feature` et `.steps.ts`

## Conception g√©n√©rale

- Architecture BDD : Feature files (.feature) en Gherkin + Step definitions (.steps.ts) en TypeScript
- S√©paration unit/integration : Tests unitaires dans __tests__/unit/ avec mocking, tests d'int√©gration dans __tests__/integration/ sans mocking
- Fixtures : Donn√©es de test r√©utilisables dans __tests__/fixtures/ (ex: nuextract-template-valid.json)
- Support : Configuration partag√©e dans __tests__/support/ (jest-cucumber-setup.js)
- Import modules test√©s : Utilisation des exports _testOnly_ selon @test-exports-governance pour acc√®s fonctions internes

## Structure de r√©pertoire

| √âl√©ment | Type | Description |
|:-----|:-----|:---|
| `/__tests__/unit/` | R√©pertoire | Tests unitaires avec mocking des d√©pendances (error-handling) |
| `/__tests__/integration/` | R√©pertoire | Tests d'int√©gration avec appels API r√©els (template-generation, nuextract-project-management) |
| `/__tests__/fixtures/` | R√©pertoire | Donn√©es de test r√©utilisables (templates valides, configurations) |
| `/__tests__/support/` | R√©pertoire | Configuration partag√©e Jest-Cucumber (jest-cucumber-setup.js) |
| `/nuextract-client-error-handling.feature` | Feature Gherkin | Sc√©narios gestion d'erreur nuextract-client (unit/) |
| `/nuextract-client-error-handling.steps.ts` | Step definitions | Impl√©mentation steps nuextract-client (unit/) |
| `/nuextract-api-error-handling.feature` | Feature Gherkin | Sc√©narios gestion d'erreur nuextract-api (unit/) |
| `/nuextract-api-error-handling.steps.ts` | Step definitions | Impl√©mentation steps nuextract-api (unit/) |
| `/template-generation.feature` | Feature Gherkin | Sc√©narios g√©n√©ration templates (integration/) |
| `/template-generation.steps.ts` | Step definitions | Impl√©mentation steps template-generation (integration/) |
| `/nuextract-project-management.feature` | Feature Gherkin | Sc√©narios gestion projets (integration/) |
| `/nuextract-project-management.steps.ts` | Step definitions | Impl√©mentation steps project-management (integration/) |

## D√©cisions architecturales et techniques

### Patterns Gherkin pour validation d'erreurs

#### Description d√©taill√©e pour Patterns Gherkin

[2025-10-26] Les step definitions utilisent des expressions r√©guli√®res JavaScript pour √©tablir la correspondance entre les steps Gherkin des fichiers `.feature` et les fonctions d'impl√©mentation TypeScript dans les fichiers `.steps.ts`, conform√©ment √† la sp√©cification jest-cucumber (bencompton/jest-cucumber sur GitHub).

[2025-10-26] M√©canisme de capture et correspondance selon la documentation jest-cucumber :

1. __D√©finition du step dans `.feature`__ : `Alors une erreur "API_KEY is not set" est g√©n√©r√©e`
2. __Pattern regex dans `.steps.ts`__ : `/^une erreur "(.*)" est g√©n√©r√©e$/`
3. __Capture du groupe__ : Le pattern `(.*)` capture le texte entre guillemets (`"API_KEY is not set"`)
4. __Param√®tre de fonction__ : La valeur captur√©e est pass√©e comme param√®tre `expectedMessage` √† la fonction step definition

[2025-10-26] Deux variantes de regex sont utilis√©es pour √©tablir la correspondance avec les steps "Then" Gherkin des fichiers `.feature` :

- __Regex n¬∞1__ : `/^une erreur "(.*)" est g√©n√©r√©e$/` - Capture le texte exact entre guillemets apr√®s le lit√©ral 'une erreur ' dans le step Gherkin, le `^` et `$` assurent une correspondance compl√®te de la ligne
- __Regex n¬∞2__ : `/^une erreur contenant "(.*)" est g√©n√©r√©e$/` - Capture le texte avec le mot-cl√© "contenant" rendant l'intention de validation partielle explicite dans le langage Gherkin

[2025-10-26] Les deux regex utilisent l'assertion Jest `.toContain()` au lieu de `.toBe()` car les messages d'erreur complets incluent contexte et terminaison "Script stopped." selon @error-handling-governance, permettant une validation partielle robuste du fragment de message captur√©.

[2025-10-26] Un step r√©utilisable "le processus s'arr√™te proprement" est syst√©matiquement d√©fini avec `and()` pour encapsuler les assertions de cleanup communes :

- V√©rifier que l'erreur est instance de Error (validation type JavaScript standard)
- Nettoyer les mocks avec `jest.clearAllMocks()` (API Jest de r√©initialisation des mocks)
- Restaurer les fonctions originales mock√©es (pattern standard Jest pour isolation des tests)

#### Justification pour Patterns Gherkin

- __Conformit√© Cucumber__ : Les expressions r√©guli√®res pour step definitions sont le m√©canisme standard Cucumber (document√© dans cucumber.io et jest-cucumber)
- __Clart√© des intentions__ : Le mot "contenant" dans le Gherkin (langage naturel) rend explicite qu'on v√©rifie une correspondance partielle
- __Flexibilit√©__ : L'assertion `.toContain()` de Jest permet de valider le fragment cl√© du message sans d√©pendre du format exact du message complet (bonne pratique Jest)
- __Robustesse__ : Les tests r√©sistent aux modifications mineures des messages d'erreur (ajout contexte, formatage) selon le principe de tests r√©silients
- __R√©utilisabilit√©__ : Le step "le processus s'arr√™te proprement" √©vite la duplication de code de cleanup (principe DRY - Don't Repeat Yourself)
- __Isolation des tests__ : Le cleanup syst√©matique des mocks garantit l'absence d'effets de bord entre tests (bonne pratique Jest document√©e)

#### Patterns valid√©s pour Patterns Gherkin

- __Pattern avec capture de groupe__ : Correspondance entre step Gherkin et step definition TypeScript

__√âtape 1 - Step Gherkin dans `.feature`__ :

```gherkin
Alors une erreur "API_KEY is not set" est g√©n√©r√©e
```

__√âtape 2 - Step definition TypeScript dans `.steps.ts`__ :

```typescript
// Pattern regex : /^une erreur "(.*)" est g√©n√©r√©e$/
// Capture : (.*) extrait "API_KEY is not set"
// Param√®tre : expectedMessage re√ßoit la valeur captur√©e
then(/^une erreur "(.*)" est g√©n√©r√©e$/, (expectedMessage) => {
  expect(error).toBeDefined();
  expect(error.message).toContain(expectedMessage);
  // expectedMessage = "API_KEY is not set"
  // Validation partielle avec .toContain() car message complet = 
  // "Configuration error: API_KEY is not set. Script stopped."
});
```

- __Pattern avec mot-cl√© "contenant"__ : Intention explicite de validation partielle dans le langage Gherkin

__√âtape 1 - Step Gherkin dans `.feature`__ :

```gherkin
Alors une erreur contenant "templateMode invalide" est g√©n√©r√©e
```

__√âtape 2 - Step definition TypeScript dans `.steps.ts`__ :

```typescript
// Pattern regex : /^une erreur contenant "(.*)" est g√©n√©r√©e$/
// Le mot "contenant" dans Gherkin documente l'intention de validation partielle
then(/^une erreur contenant "(.*)" est g√©n√©r√©e$/, (expectedMessage) => {
  expect(error).toBeDefined();
  expect(error.message).toContain('templateMode invalide');
  // Message complet peut √™tre : "Validation error: templateMode invalide: ..."
});
```

- __Step cleanup r√©utilisable__ : Encapsulation des assertions de cleanup selon principe DRY

```typescript
// Step "And" standard Gherkin pour cleanup apr√®s assertion d'erreur
and('le processus s\'arr√™te proprement', () => {
  // Validation type JavaScript standard
  expect(error).toBeInstanceOf(Error);
  
  // R√©initialisation des mocks Jest (√©vite effets de bord entre tests)
  jest.clearAllMocks();
  
  // Restauration des fonctions originales mock√©es (pattern Jest standard)
  if (originalReadFileSync) {
    fs.readFileSync = originalReadFileSync;
  }
});
```

#### Anti-Patterns pour Patterns Gherkin √† √©viter

- __Assertion `.toBe()` sur message complet__ : √âviter `expect(error.message).toBe("Configuration error: Invalid JSON in configuration file. Script stopped.")` ‚Üí __Solution__ : Utiliser `.toContain("Invalid JSON")` pour valider uniquement le fragment cl√© ‚Üí __R√®gle √† adopter__ : Validation partielle robuste selon bonnes pratiques Jest (tests r√©silients aux changements de formatage)

- __Regex sans groupe de capture__ : √âviter `/^une erreur est g√©n√©r√©e$/` qui ne capture aucune valeur ‚Üí __Solution__ : Utiliser `/^une erreur "(.*)" est g√©n√©r√©e$/` avec groupe de capture `(.*)` ‚Üí __R√®gle √† adopter__ : Regex avec capture explicite selon m√©canisme standard Cucumber step definitions

- __Pas de cleanup des mocks__ : √âviter oubli de `jest.clearAllMocks()` et restauration des fonctions mock√©es ‚Üí __Solution__ : Step r√©utilisable "le processus s'arr√™te proprement" ‚Üí __R√®gle √† adopter__ : Cleanup syst√©matique pour isolation des tests (bonne pratique Jest document√©e, √©vite effets de bord entre tests)

- __Hardcoding valeur dans step definition__ : √âviter `expect(error.message).toContain('templateMode invalide')` avec valeur en dur alors que le pattern capture `expectedMessage` ‚Üí __Solution__ : Utiliser le param√®tre captur√© `expect(error.message).toContain(expectedMessage)` ‚Üí __R√®gle √† adopter__ : Exploitation syst√©matique des groupes de capture regex pour r√©utilisabilit√© du step definition

#### √âtat d'impl√©mentation pour Patterns Gherkin

‚úÖ [Fonctionnalit√© r√©alis√©e - 2025-10-26]

### Tests de validation loadInstructions (fonction loadInstructions)

#### Description d√©taill√©e pour Tests loadInstructions

[2025-10-29] Les tests unitaires de `loadInstructions()` valident 3 cas d'erreur correspondant aux 3 √©tapes de traitement : lecture fichier (ENOENT), recherche heading, validation contenu extrait.

#### Justification pour Tests loadInstructions

- __Criticit√© des instructions__ : Essentielles pour transformation correcte des √©num√©rations JSON Schema vers format NuExtract
- __D√©tection pr√©coce__ : Erreurs d√©tect√©es avant appel API (√©conomie quota)
- __Exhaustivit√©__ : Couverture compl√®te des 3 √©tapes de traitement

#### Patterns valid√©s pour Tests loadInstructions

- __Mocking fs.readFileSync__ : Simulation fichier manquant (ENOENT), heading absent, contenu vide
- __Error Cause__ : Pr√©servation de l'erreur originale pour ENOENT
- __Messages explicites__ : Conformit√© @error-handling-governance

#### Anti-Patterns pour Tests loadInstructions √† √©viter

- __Validation laxiste__ : √âviter retour `''` en cas d'erreur ‚Üí __Solution__ : Lever erreur explicite ‚Üí __R√®gle__ : Gestion stricte selon @error-handling-governance

#### √âtat d'impl√©mentation pour Tests loadInstructions

‚úÖ [Fonctionnalit√© r√©alis√©e - 2025-10-29] - 3 sc√©narios BDD dans nuextract-client-error-handling.feature

### Tests de validation nuextract-api (module nuextract-api.js)

#### Description d√©taill√©e pour Tests nuextract-api

[2025-10-29] Les tests unitaires du module `nuextract-api.js` valident la gestion d'erreur robuste des 7 fonctions d'appel HTTP vers l'API NuExtract avec simulation des cas d'erreur r√©seau, timeout, codes HTTP non-200, et JSON invalide.

#### Justification pour Tests nuextract-api

- __Couche critique__ : Module API/I/O isolant tous les appels HTTP externes
- __Gestion d'erreur stricte__ : Conformit√© @error-handling-governance avec Error Cause
- __Testabilit√© am√©lior√©e__ : Mocking du module https pour simuler tous les cas d'erreur
- __Couverture exhaustive__ : Tous les chemins d'erreur de chaque fonction test√©s

#### Patterns valid√©s pour Tests nuextract-api

- __Mock https.request__ : Simulation EventEmitter pour req et res
- __Error Cause pr√©serv√©e__ : Validation que error.cause contient l'erreur originale
- __Messages explicites__ : Conformit√© messages d'erreur avec code nuextract-api.js

#### Anti-Patterns pour Tests nuextract-api √† √©viter

- __Tests d'int√©gration dans unit/__ : √âviter appels API r√©els ‚Üí __Solution__ : Mocking complet ‚Üí __R√®gle__ : S√©paration stricte unit/integration

#### √âtat d'impl√©mentation pour Tests nuextract-api

‚úÖ [Fonctionnalit√© r√©alis√©e - 2025-10-29] - 16 sc√©narios BDD dans nuextract-api-error-handling.feature

### Mocking pour tests unitaires

#### Description d√©taill√©e pour Mocking

[2025-10-26] Les tests unitaires (error-handling) utilisent le mocking pour isoler les d√©pendances externes :

- __Mocking fs.readFileSync__ : Simule fichiers manquants (ENOENT) ou JSON invalide
- __Mocking module nuextract-api.js__ : Utilise jest.mock() pour mocker le module complet, puis jest.spyOn() pour mocker des fonctions sp√©cifiques
- __Restauration obligatoire__ : Les mocks sont restaur√©s dans le step "le processus s'arr√™te proprement" pour √©viter pollution entre tests

[2025-10-26] Pattern de mocking module API :

```typescript
// Mock global du module au d√©but du fichier
jest.mock('../../src/nuextract-api.js', () => {
  const actual = jest.requireActual('../../src/nuextract-api.js');
  return {
    ...actual,
    inferTemplateFromDescriptionAsync: jest.fn(actual.inferTemplateFromDescriptionAsync)
  };
});

// Import du module mock√©
import * as nuextractApi from '../../src/nuextract-api.js';

// Spy sur fonction sp√©cifique dans un test
jest.spyOn(nuextractApi, 'inferTemplateFromDescriptionAsync').mockResolvedValue({...});
```

#### Justification pour Mocking

- __Isolation__ : Tests unitaires ne d√©pendent pas de l'√©tat du filesystem ou de la disponibilit√© de l'API NuExtract
- __Rapidit√©__ : Pas d'I/O r√©el, ex√©cution rapide (<1s par test)
- __Fiabilit√©__ : Pas d'√©checs al√©atoires dus √† r√©seau ou quota API
- __Contr√¥le__ : Simulation pr√©cise de cas d'erreur difficiles √† reproduire (ENOENT, JSON malform√©, timeout)

#### Patterns valid√©s pour Mocking

- __Mock fs pour fichier manquant__ :

```typescript
const originalReadFileSync = fs.readFileSync;
fs.readFileSync = jest.fn().mockImplementation(() => {
  const err = new Error('ENOENT: no such file or directory');
  err.code = 'ENOENT';
  throw err;
});
```

- __Mock fs pour JSON invalide__ :

```typescript
fs.readFileSync = jest.fn().mockImplementation((filePath, encoding) => {
  if (filePath.includes('extraction-config.json')) {
    return '{ invalid json ,,, }';
  }
  return originalReadFileSync(filePath, encoding);
});
```

- __Mock module API avec spy__ :

```typescript
jest.spyOn(nuextractApi, 'inferTemplateFromDescriptionAsync')
  .mockResolvedValue({ jobId: null });
```

#### Anti-Patterns pour Mocking √† √©viter

- __Tests r√©els dans unit/__ : √âviter appels API r√©els dans tests unitaires ‚Üí __Solution__ : D√©placer vers integration/ ‚Üí __R√®gle √† adopter__ : S√©paration stricte unit/integration
- __Pas de restauration mocks__ : √âviter pollution entre tests ‚Üí __Solution__ : Restaurer dans cleanup ‚Üí __R√®gle √† adopter__ : jest.clearAllMocks() syst√©matique
- __Mock partiel incomplet__ : √âviter de mocker module sans ...actual ‚Üí __Solution__ : Spread actual ‚Üí __R√®gle √† adopter__ : Pr√©server fonctions non mock√©es

#### √âtat d'impl√©mentation pour Mocking

‚úÖ [Fonctionnalit√© r√©alis√©e - 2025-10-26]

### Usage des fixtures pour les tests d'erreurs NuExtract

#### Description d√©taill√©e

[2025-11-09] Les tests unitaires qui v√©rifient la bonne impl√©mentation de la gestion des erreurs n'invoquent plus les endpoints NuExtract (modes sync ou async). Ils s'appuient exclusivement sur des mocks et sur des fixtures repr√©sentatives (ex. `__tests__/fixtures/nuextract-template-valid.json`) afin de :

- valider la logique d'erreur sans d√©pendance r√©seau ;
- ma√Ætriser la consommation de quota NuExtract ;
- garantir des ex√©cutions rapides et d√©terministes.

#### Patterns valid√©s

- Charger les entr√©es de r√©f√©rence (templates, r√©ponses API) depuis des fixtures au lieu d'appeler `generateTemplate()` ou d'autres wrappers API.
- Mock `nuextract-api.js` pour forcer les chemins d'erreur attendus.
- Conserver les assertions existantes sur les messages et le wrapping Error Cause.

#### Anti-patterns √† √©viter

- Laisser un test unitaire invoquer `generateTemplate()` ou un appel NuExtract r√©el.
- D√©pendre d'un timeout r√©seau ou d'une erreur d'acc√®s pour d√©clencher le sc√©nario.

#### √âtat d'impl√©mentation

üöß [D√©ploiement en cours - 2025-11-09] : transition progressive des sc√©narios unitaires vers cet usage syst√©matique des fixtures.

### Ex√©cution end-to-end de l'agent NuExtract

#### Description d√©taill√©e pour ex√©cution end-to-end de l'agent NuExtract

- Le sc√©nario E2E `hermes2022-concepts-workflow` ex√©cute l'agent complet `nuextract-client.js` via `execFileAsync`, reproduisant exactement le contexte d'ex√©cution utilis√© dans JArchi.
- Un r√©pertoire temporaire `tmp-artifacts/<timestamp-pid>` est inject√© dans la variable d'environnement `HERMES2022_CONCEPTS_ARTIFACT_DIR`, garantissant l'isolation de chaque session conform√©ment √† @test-mock-governance.
- L'ex√©cution est encapsul√©e dans un timeout de 120 secondes, valeur align√©e avec la gouvernance @bdd-governance (tests d'int√©gration mode async) et la sp√©cification de tests qui impose un d√©lai suffisant pour les workflows NuExtract (sleep initial puis polling des jobs).
- Les assertions v√©rifient la pr√©sence de l'artefact dat√© du jour ainsi que de son sidecar d'approbation initialis√© √† `pending` pour `/concepts/overview`, assurant la tra√ßabilit√© et le visa humain attendus par @specification-hermes2022-concepts-site-extraction.

#### Justification pour ex√©cution end-to-end de l'agent NuExtract

- __Parit√© production__ : lancer `nuextract-client.js` via `execFileAsync` excecute le point d'entr√©e r√©el (`require.main === module`), valide la r√©solution des chemins, le chargement des d√©pendances et l'encha√Ænement `main()` ‚Üí `process.exit`, exactement comme dans JArchi.
- __Couverture orchestration__ : l'ex√©cution ‚Äúbo√Æte noire‚Äù v√©rifie l'ordre complet des op√©rations (lecture configuration, validation JWT, g√©n√©ration du template async, gestion projet NuExtract, sauvegarde artefacts, cr√©ation du sidecar) au-del√† des exports `_testOnly_` unitaires.
- __Robustesse__ : le timeout de 120 secondes absorbe les dur√©es requises par le mode async (sleep initial + polling) tout en d√©tectant les blocages √©ventuels.
- __Gestion des erreurs__ : un √©chec de l'agent remonte via le code de retour du processus et les messages ‚ÄúScript stopped.‚Äù, ce qui valide la mise en ≈ìuvre de @error-handling-governance dans le contexte runtime (logs, propagation, exit code).
- __Tra√ßabilit√©__ : la validation des artefacts g√©n√©r√©s, y compris le sidecar d'approbation, garantit que l'orchestration respecte les exigences m√©tier (journalisation, visa humain) d√©finies dans la sp√©cification g√©n√©rale du module.

### Timeouts diff√©renci√©s selon type de test

#### Description d√©taill√©e pour Timeouts

[2025-10-26] Les timeouts Jest sont adapt√©s selon le type de test et la dur√©e d'ex√©cution attendue :

- __Tests unitaires__ : 15000ms (15s) - Timeout global configur√© dans
  `hermes2022-concepts-site-extraction/jest.config.js` et r√©pliqu√© par la
  configuration racine `jest.config.js`
- __Tests int√©gration mode sync__ : 45000ms (45s) - Timeout par test pour appel API synchrone `/api/infer-template`
- __Tests int√©gration mode async__ : 120000ms (2 minutes) - Timeout par test pour workflow async complet (sleep 30s + polling)

[2025-10-26] Configuration timeout par test avec param√®tre :

```typescript
test('G√©n√©ration de template NuExtract avec infer-template-async', ({ given, when, then, and }) => {
  // ... test implementation
}, 120000);  // Timeout de 2 minutes
```

#### Justification pour Timeouts

- __Tests unitaires__ : Ex√©cution rapide (<1s), timeout 15s largement suffisant
- __Mode sync API__ : Appel HTTP unique avec g√©n√©ration template (~11s constat√© empiriquement), timeout 45s s√©curitaire
- __Mode async API__ : Sleep initial 30s + polling max 60s = 90s th√©orique, timeout 120s avec marge confortable
- __√âvite faux n√©gatifs__ : Timeouts adapt√©s √©vitent √©checs tests dus √† latence r√©seau acceptable

#### Patterns valid√©s pour Timeouts

- __Timeout global dans config__ :

```javascript
// hermes2022-concepts-site-extraction/jest.config.js
module.exports = {
  testTimeout: 15000,  // 15 secondes par d√©faut
  // ...
};
```

- __Timeout par test d'int√©gration__ :

```typescript
test('G√©n√©ration de template NuExtract avec infer-template-async', 
  ({ given, when, then, and }) => {
    // Test implementation
  }, 
  120000  // Override timeout pour ce test
);
```

#### Anti-Patterns pour Timeouts √† √©viter

- __Timeout global insuffisant__ : √âviter timeout unique 5000ms pour tous tests ‚Üí __Solution__ : Diff√©rencier par type ‚Üí __R√®gle √† adopter__ : Timeout adapt√© √† la dur√©e r√©elle
- __Pas de timeout explicite__ : √âviter de d√©pendre du timeout Jest par d√©faut ‚Üí __Solution__ : Configurer explicitement ‚Üí __R√®gle √† adopter__ : Timeouts document√©s
- __Timeout trop court__ : √âviter timeout <2x dur√©e attendue ‚Üí __Solution__ : Marge s√©curit√© 50% ‚Üí __R√®gle √† adopter__ : Tol√©rance latence r√©seau

#### √âtat d'impl√©mentation pour Timeouts

‚úÖ [Fonctionnalit√© r√©alis√©e - 2025-10-26]

### S√©paration tests unitaires et tests d'int√©gration

#### Description d√©taill√©e pour S√©paration unit/integration

[2025-10-26] L'architecture des tests suit une s√©paration stricte entre tests unitaires et tests d'int√©gration selon leur nature :

- __Tests unitaires__ (`__tests__/unit/`) : error-handling avec mocking de toutes les d√©pendances externes (fs, API)
- __Tests d'int√©gration__ (`__tests__/integration/`) : template-generation et nuextract-project-management avec appels API r√©els

[2025-10-26] Cette s√©paration est refl√©t√©e dans la configuration
`hermes2022-concepts-site-extraction/jest.config.js` :

```javascript
testMatch: [
  '__/__tests__/{unit,integration}/__/*.steps.{js,ts}'
],
```

#### Justification pour S√©paration unit/integration

- __Clart√©__ : Distinction imm√©diate entre tests isol√©s et tests end-to-end
- __Ex√©cution s√©lective__ : Possibilit√© d'ex√©cuter uniquement tests unitaires rapides en d√©veloppement
- __Maintenance__ : Identification facilit√©e des tests √† adapter lors de changements API vs logique interne
- __Standard BDD__ : Architecture reconnue align√©e avec @bdd-governance

#### Patterns valid√©s pour S√©paration unit/integration

- __Structure r√©pertoires__ :

```text
__tests__/
‚îú‚îÄ‚îÄ unit/
‚îÇ   ‚îú‚îÄ‚îÄ nuextract-client-error-handling.feature
‚îÇ   ‚îú‚îÄ‚îÄ nuextract-client-error-handling.steps.ts
‚îÇ   ‚îú‚îÄ‚îÄ nuextract-api-error-handling.feature
‚îÇ   ‚îî‚îÄ‚îÄ nuextract-api-error-handling.steps.ts
‚îú‚îÄ‚îÄ integration/
‚îÇ   ‚îú‚îÄ‚îÄ template-generation.feature
‚îÇ   ‚îú‚îÄ‚îÄ template-generation.steps.ts
‚îÇ   ‚îú‚îÄ‚îÄ nuextract-project-management.feature
‚îÇ   ‚îî‚îÄ‚îÄ nuextract-project-management.steps.ts
‚îú‚îÄ‚îÄ fixtures/
‚îÇ   ‚îî‚îÄ‚îÄ nuextract-template-valid.json
‚îî‚îÄ‚îÄ support/
    ‚îî‚îÄ‚îÄ jest-cucumber-setup.js
```

- __Imports relatifs adapt√©s__ :

```typescript
// Dans __tests__/unit/nuextract-client-error-handling.steps.ts
require('../../../src/nuextract-client.js')  // Remonte 3 niveaux

// Dans __tests__/integration/template-generation.steps.ts
require('../../src/nuextract-client.js')     // Remonte 2 niveaux
```

#### Anti-Patterns pour S√©paration unit/integration √† √©viter

- __M√©lange dans m√™me fichier__ : √âviter tests mock√©s et r√©els dans error-handling ‚Üí __Solution__ : S√©parer par r√©pertoire ‚Üí __R√®gle √† adopter__ : Architecture unit/integration stricte
- __Nomenclature ambigu√´__ : √âviter noms g√©n√©riques "tests/" ‚Üí __Solution__ : Nommer explicitement unit/ et integration/ ‚Üí __R√®gle √† adopter__ : Clart√© intentionnelle
- __Tests r√©els dans unit/__ : √âviter appels API dans tests unitaires ‚Üí __Solution__ : D√©placer vers integration/ ‚Üí __R√®gle √† adopter__ : Respect s√©paration responsabilit√©s

#### √âtat d'impl√©mentation pour S√©paration unit/integration

‚úÖ [Fonctionnalit√© r√©alis√©e - 2025-10-26]

### Configuration Jest standard pour monorepo

#### Description d√©taill√©e pour Configuration Jest

[2025-10-26] Le projet hermes2022-to-archimate adopte l'architecture monorepo standard Jest avec :

- __jest.config.js racine__ : Orchestre les projets via `projects: [...]`, d√©finit le timeout global
- __jest.config.js module__ : Configuration sp√©cifique BDD (testMatch, transform, testEnvironment) pour chaque module
- __package.json racine__ : Scripts npm pour ex√©cution globale ou s√©lective (`test`, `test:unit`, `test:integration`)

[2025-10-26] Tous les modules utilisent le nommage standard `jest.config.js` (pas de nommage personnalis√© comme `cucumber-jest.config.js`) pour :

- D√©couverte automatique par les outils (IDE, CI/CD)
- Coh√©rence avec l'√©cosyst√®me Jest
- Maintenabilit√© √† long terme

#### Justification pour Configuration Jest

- __Standard universel__ : `jest.config.js` est reconnu par tous les outils et frameworks
- __D√©couverte automatique__ : IDEs (VSCode, IntelliJ) d√©tectent automatiquement les configurations Jest standard
- __Documentation__ : Le fait que ce soit du BDD est document√© via jest-cucumber dans les d√©pendances et le commentaire du fichier
- __√âvolutivit√©__ : Facilite l'ajout de nouveaux modules (hermes2022-ia-loader, archimate-model-loader) avec configuration coh√©rente

#### Patterns valid√©s pour Configuration Jest

- __Architecture fichiers__ :

```text
hermes2022-to-archimate/
‚îú‚îÄ‚îÄ jest.config.js                          # Orchestration monorepo
‚îú‚îÄ‚îÄ package.json                            # Scripts npm
‚îú‚îÄ‚îÄ hermes2022-concepts-site-extraction/
‚îÇ   ‚îî‚îÄ‚îÄ jest.config.js                      # Config BDD module
‚îî‚îÄ‚îÄ hermes2022-ia-loader/
    ‚îî‚îÄ‚îÄ jest.config.js                      # Config BDD module (futur)
```

- __Configuration racine__ :

```javascript
module.exports = {
  projects: [
    '<rootDir>/hermes2022-concepts-site-extraction/jest.config.js'
  ],
  testTimeout: 15000
};
```

- __Configuration module__ :

```javascript
// Configuration Jest BDD (jest-cucumber) pour hermes2022-concepts-site-extraction
module.exports = {
  testMatch: ['__/__tests__/{unit,integration,e2e}/__/*.steps.{js,ts}'],
  // ...
};
```

- __Scripts npm__ :

```json
{
  "scripts": {
    "test": "jest",
    "test:unit": "jest --testPathPattern=__tests__/unit",
    "test:integration": "jest --testPathPattern=__tests__/integration"
  }
}
```

#### Anti-Patterns pour Configuration Jest √† √©viter

- __Nommage personnalis√©__ : √âviter `cucumber-jest.config.js` ‚Üí __Solution__ : Utiliser `jest.config.js` ‚Üí __R√®gle √† adopter__ : Standard Jest universel
- __Configuration plate__ : √âviter un seul jest.config.js pour tous les modules ‚Üí __Solution__ : Architecture monorepo ‚Üí __R√®gle √† adopter__ : Configuration par module orchestr√©e
- __Chemins absolus__ : √âviter chemins absolus dans projects ‚Üí __Solution__ : Utiliser `<rootDir>` ‚Üí __R√®gle √† adopter__ : Portabilit√© configuration

#### √âtat d'impl√©mentation pour Configuration Jest

‚úÖ [Fonctionnalit√© r√©alis√©e - 2025-10-26]
