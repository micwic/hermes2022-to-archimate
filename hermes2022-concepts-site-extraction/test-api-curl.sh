#!/bin/bash
# Curl exact reproduisant l'appel à /api/infer-template-async
# Usage: chmod +x test-api-curl.sh && ./test-api-curl.sh

NUEXTRACT_API_KEY=$(cat hermes2022-concepts-site-extraction/config/nuextract-api-key.key)

curl -v "https://nuextract.ai/api/infer-template-async?timeout=60s" \
  -X POST \
  -H "Authorization: Bearer $NUEXTRACT_API_KEY" \
  -H "Content-Type: application/json" \
  -d '
{"description":"{\n  \"$schema\": \"http://json-schema.org/draft-07/schema#\",\n  \"$id\": \"https://github.com/micwic/hermes2022-to-archimate/shared/hermes2022-extraction-files/config/json-schemas/hermes2022-concepts.json\",\n  \"title\": \"HERMES2022 Method Extraction Schema\",\n  \"description\": \"Schéma de validation pour les fichiers intermédiaires d'extraction des concepts de la méthode HERMES2022\",\n  \"type\": \"object\",\n  \"properties\": {\n    \"config\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"extractionSource\": {\n          \"type\": \"object\",\n          \"properties\": {\n            \"baseUrl\": {\n              \"type\": \"string\",\n              \"enum\": [\n                \"https://www.hermes.admin.ch/de\",\n                \"https://www.hermes.admin.ch/fr\",\n                \"https://www.hermes.admin.ch/it\",\n                \"https://www.hermes.admin.ch/en\"\n              ],\n              \"default\": \"https://www.hermes.admin.ch/en\",\n              \"description\": \"URL de base utilisée pour l'extraction, enregistrée au moment de l'extraction\"\n            },\n            \"language\": {\n              \"type\": \"string\",\n              \"enum\": [\"de\", \"fr\", \"it\", \"en\"],\n              \"default\": \"en\",\n              \"description\": \"Code de langue utilisé pour l'extraction, enregistré au moment de l'extraction\"\n            },\n            \"description\": {\n              \"type\": \"string\",\n              \"maxLength\": 500,\n              \"description\": \"Description de la source de référence pour l'extraction et transformation des concepts de la méthode HERMES2022\"\n            }\n          },\n          \"required\": [\"baseUrl\", \"language\", \"description\"],\n          \"additionalProperties\": false\n        }\n      },\n      \"required\": [\"extractionSource\"],\n      \"additionalProperties\": false\n    },\n    \"method\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"hermesVersion\": {\n          \"type\": \"string\",\n          \"enum\": [\"5\", \"5.1\", \"2022\"],\n          \"default\": \"2022\",\n          \"description\": \"Version de la méthode HERMES (5, 5.1, 2022). La valeur par défaut est 2022.\"\n        },\n        \"publicationDate\": {\n          \"type\": \"string\",\n          \"pattern\": \"^(0[1-9]|1[0-2])-[0-9]{4}$\",\n          \"default\": \"04-2023\",\n          \"description\": \"Date de publication de la version HERMES (MM-YYYY). La valeur par défaut est 04-2023.\"\n        },\n        \"overview\": {\n          \"type\": \"string\",\n          \"minLength\": 600,\n          \"maxLength\": 5000,\n          \"description\": \"Description générale des concepts de HERMES2022\"\n        },\n        \"sourceUrl\": {\n          \"type\": \"string\",\n          \"format\": \"uri\",\n          \"enum\": [\n            \"/\"\n          ],\n          \"default\": \"/\",\n          \"description\": \"URL des pages de référence utilisées pour cette description. Ces pages sont utilisées pour extraire la description générale de la méthode HERMES2022.\"\n        },\n        \"lastChecked\": {\n          \"type\": \"string\",\n          \"format\": \"date\",\n          \"description\": \"Date de dernière vérification de la source.\"\n        }\n      },\n      \"required\": [\"hermesVersion\", \"publicationDate\", \"overview\", \"sourceUrl\", \"lastChecked\"],\n      \"additionalProperties\": false\n    },\n    \"concepts\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"overview\": {\n          \"type\": \"string\",\n          \"minLength\": 600,\n          \"maxLength\": 5000,\n          \"description\": \"Description générale des concepts de HERMES2022\"\n        },\n        \"sourceUrl\": {\n          \"type\": \"string\",\n          \"format\": \"uri\",\n          \"enum\": [\n            \"/project-management/method-overview.html\",\n            \"/project-management/method-overview/preface.html\"\n          ],\n          \"description\": \"URL des pages de référence utilisées pour cette description. Ces pages sont utilisées pour extraire la description générale des concepts de HERMES2022.\"\n        },\n        \"lastChecked\": {\n          \"type\": \"string\",\n          \"format\": \"date\",\n          \"description\": \"Date de dernière vérification de la source.\"\n        },\n        \"concept-phases\": {\n          \"$ref\": \"./hermes2022-phases.json\",\n          \"description\": \"Concept de phases HERMES2022 - détail des phases de la méthode\"\n        }\n      },\n      \"required\": [\"overview\", \"sourceUrl\", \"lastChecked\", \"concept-phases\"],\n      \"additionalProperties\": false\n    }\n  },\n  \"required\": [\"config\", \"method\", \"concepts\"],\n  \"additionalProperties\": false\n}\n\n\n\n- transformes le schéma JSON en template NuExtract\n- considères les énumérations JSON comme par exemple \"language\": {\"type\": \"string\",\"enum\": [\"de\", \"fr\", \"it\", \"en\"]} comme des énumérations dans le format de template NuExtract \"language\": [\"de\", \"fr\", \"it\", \"en\"]"}
'

echo ""
echo "Job lancé, récupérez le jobId pour polling avec:"
echo "curl -s \"https://nuextract.ai/api/jobs/{jobId}\" -H \"Authorization: Bearer \$NUEXTRACT_API_KEY\" | python3 -m json.tool"
