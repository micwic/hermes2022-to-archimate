---
description: Sp√©cification g√©n√©rale du module hermes2022-concepts-site-extraction
alwaysApply: true
---

# specification-hermes2022-concepts-site-extraction.mdc: Sp√©cification g√©n√©rale du module hermes2022-concepts-site-extraction

Chemin : hermes2022-to-archimate/hermes2022-concepts-site-extraction/.cursor/rules/

> Cr√©√© le : 2025-08-16
> Derni√®re mise √† jour : 2025-11-10

## Description g√©n√©rale

- La m√©thode HERMES des gestion de projet et de programme de la Conf√©d√©ration Helv√©tique est d√©crite en anglais sur le site <https://www.hermes.admin.ch/en/>
- __Finalit√© du module__ : Extraire automatiquement les concepts HERMES2022 depuis les pages officielles sp√©cifiques et les transformer en fichiers interm√©diaires structur√©s JSON valid√©s
- __Port√©e du module__ : Extraction cibl√©e des concepts de la m√©thode HERMES2022 avec leur contexte et articulation g√©n√©rale, selon la hi√©rarchie officielle (1=Initiation, 2=Execution avec 2.1=Concept, 2.2=Implementation, 2.3=Deployment, 3=Closure)
- __Interface de sortie__ : Fichiers JSON conformes aux sch√©mas d√©finis dans le module hermes2022-extraction-files

## Contexte

- Sp√©cification amont @.cursor/rules/specification-hermes2022-to-archimate.mdc
- Les m√©thodes HERMES de gestion de portefeuille et de gestion des applications sont hors contexte, elles sont ignor√©es
- La m√©thode HERMES2022 de gestion de projet et de programme de la Conf√©d√©ration Helv√©tique est d√©crite en plusieurs langues : allemand, fran√ßais, italien et anglais
- La racine du site <https://www.hermes.admin.ch> est modifi√©e automatiquement √† la langue par d√©faut ou est celle d√©finie dans l'url lors de la requ√™te
- L'url du site en allemand est <https://www.hermes.admin.ch/de/>
- L'url du site en fran√ßais est <https://www.hermes.admin.ch/fr/>
- L'url du site en italien est <https://www.hermes.admin.ch/it/>
- L'url du site en anglais est <https://www.hermes.admin.ch/en/>

## Objectifs

- Faire extraire par l'IA les concepts HERMES2022 jug√©s pertinents pour le projet des pages identifi√©es comme pertinentes du site internet de r√©f√©rence dans la langue souhait√©e.
- Faire transformer par l'IA les donn√©es jug√©es pertinentes pour les enregistrer dans des fichiers interm√©diaires structur√©s, lisibles et v√©rifiables par un humain avant chargement ult√©rieur

## Conception g√©n√©rale

- Un fichier de configuration JSON de l'extraction contient les propri√©t√©s utiles √† celle-ci
- Le processus d'extraction est un agent sp√©cialis√© :
  - **Javascript Node.js** avec √©cosyst√®me npm (Jest, Ajv, jsonwebtoken, html-to-text, find-up)
  - Produit des **fichiers JSON interm√©diaires** valid√©s et structur√©s
  - Fichiers JSON consomm√©s ensuite par un **script JArchi** pour chargement dans Archi (module `archimate-model-loader`)
  - G√©n√©rique et configurable, son ex√©cution conforme est bas√©e sur le contenu du fichier de configuration et sur les d√©finitions de structure du fichier interm√©diaire cible
- L'extraction des contenus du site internet est assur√©e par l'agent sp√©cialis√© √† partir des urls d√©finies pour chaque concept dans le fichier de configuration
- Les transformations sont effectu√©es par l'IA sp√©cialis√©e NuExtract en faisant appel aux APIs disponibles en mode SaaS dans un projet nomm√© HERMES2022 qui peut comprendre des exemples ajustables propres √† chaque contexte directement dans la plateforme SaaS en dehors du code de l'agent.
- Les concept HERMES2022 jug√©s pertinents sont, en plus de la vue g√©n√©rale de la m√©thode dans son ensemble : 1) Les phases, 2) Les sc√©narios, 3) Les modules, 4) Les t√¢ches, 5) Les r√©sultats, 6) Les r√¥les
- les structures cibles de la transformation sont les structures et types d√©finis pour les fichiers interm√©diaires JSON

## Structure de r√©pertoire

| √âl√©ment | Type | Description |
|:--------|:-----|:------------|
| `/src/` | R√©pertoire | Code source de l'agent JavaScript pour l'extraction via APIs NuExtract |
| `/src/nuextract-client.js` | Code | Client logique m√©tier (orchestration, validation, transformation, fallbacks config) - Exports `_testOnly_` pour tests |
| `/src/nuextract-api.js` | Code | Module API (appels HTTP vers APIs NuExtract) - Fonctions pures avec Dependency Injection - Exports normaux |
| `find-up` + snippet racine | Pattern | R√©solution robuste des chemins depuis la racine du repository selon @root-directory-governance (snippet `fullFilePath` + `repoRoot`) |
| `/config/` | R√©pertoire | Configuration de l'extraction et param√®tres pour l'agent JS |
| `/config/extraction-config.schema.json` | Sch√©ma | Sch√©ma JSON Schema Draft-07 source de param√©trage avec pattern enum pour configuration technique |

## D√©cisions architecturales et techniques

### Site internet de r√©f√©rence HERMES2022

#### Justification pour le site internet de r√©f√©rence HERMES2022 en anglais

- La documentation de r√©f√©rence du projet est en anglais, les mod√®les Archimate sont donc en anglais, le site de r√©f√©rence √† prendre en consid√©ration pour HERMES2022 celui en anglais (<https://www.hermes.admin.ch/en/>).

#### Description d√©taill√©e pour le site internet de r√©f√©rence HERMES2022

- [2025-08-16] La racine du site internet de r√©f√©rence pour l'extraction des concepts HERMES2022 est <https://www.hermes.admin.ch/en/>. Elle permet de d√©finir la version de la m√©thodologie.
- [2025-10-16] La vue g√©n√©rale de la m√©thodologie est d√©crite dans les pages : <br>- <https://www.hermes.admin.ch/en/project-management/method-overview.html><br>- <https://www.hermes.admin.ch/en/project-management/method-overview/hermes-project-management-method-components.html><br>- <https://www.hermes.admin.ch/en/project-management/method-overview/preface.html>
- [2025-08-16] Les phases sont d√©crites dans les pages : <br>- <https://www.hermes.admin.ch/en/project-management/phases.html><br>- <https://www.hermes.admin.ch/en/project-management/phases/initiation.html><br>- <https://www.hermes.admin.ch/en/project-management/phases/concept.html><br>- <https://www.hermes.admin.ch/en/project-management/phases/implementation.html><br>- <https://www.hermes.admin.ch/en/project-management/phases/deployment.html><br>- <https://www.hermes.admin.ch/en/project-management/phases/execution.html><br>- <https://www.hermes.admin.ch/en/project-management/phases/closure.html>

#### Patterns valid√©s √† suivre suite √† la d√©cision

- __URL RACINE__ √† utiliser pour les requ√™tes internet est <https://www.hermes.admin.ch/en/>

#### √âtat d'impl√©mentation de la d√©cision

üöß [En cours de sp√©cification et r√©alisation]

### Approche hybride IA : Javascript et mod√®le LLM sp√©cialis√© NuExtract dans le cloud par API

#### Description d√©taill√©e pour l'approche hybride IA

- [2025-10-14] L'extraction des concepts HERMES2022 utilise une approche hybride en deux phases : Phase 1 avec l'extraction de pages internet de r√©f√©rences par Javascript qui aliment des appels √† l'IA sp√©cialis√©e NuExtract par les APIs disponibles dans le cloud pour synth√©tiser les contenus et assurer la transformation dans le format JSON.
- [2025-08-16] L'approche doit permettre la r√©utilisation des comportements dans d'autres contextes que le projet actuel, notamment avec du param√©trage (autres contenants et contenus, autres instructions pour l'IA).
- [2025-11-09] Le composant s'ex√©cute en **Node.js** pour l'extraction et la transformation
- [2025-11-09] Les fichiers JSON produits sont charg√©s dans Archi via un **script JArchi s√©par√©** (module `archimate-model-loader`)

#### Justification pour l'approche hybride IA avec NuExtract

- NuExtract est un LLM sp√©cialis√© pour l'extraction de donn√©es √† partir de diff√©rentes sources pour transformation dans un format structur√©s tel que JSON
- Une plateforme SaaS est disponible et gratuite avec de faible volume de donn√©es

#### Patterns valid√©s pour l'approche hybride IA

Exemples de la documentation officielle :

```bash
 curl "https://nuextract.ai/api/projects" \
  -H "Authorization: Bearer $NUEXTRACT_API_KEY"
```

```bash
PROJECT_ID="4c64870d-da8c-4718-aea9-fb2f86f07b42"
curl "https://nuextract.ai/api/projects/$PROJECT_ID/extract" \
  -X "POST" \
  -H "Authorization: Bearer $NUEXTRACT_API_KEY" \
  -H "content-type: text/plain" \
  -d "This is a text"
```

```bash
  PROJECT_ID="4c64870d-da8c-4718-aea9-fb2f86f07b42"
curl "https://nuextract.ai/api/projects/$PROJECT_ID/extract" \
  -X "POST" \
  -H "Authorization: Bearer $NUEXTRACT_API_KEY" \
  -H "content-type: application/octet-stream" \
  --data-binary @file_name.ext
```

L'ensemble des APIs NuExtract sont d√©crites dans @hermes2022-concepts-site-extraction/.cursor/rules/nuextract-platform.yaml qui est la r√©f√©rence officielle √† utiliser

#### Anti-Patterns pour l'approche hybride IA √† √©viter

- N√©ant

#### √âtat d'impl√©mentation pour l'approche hybride IA

üöß [En cours de conception et r√©alisation]

### Architecture modulaire selon principes SOLID

#### Description d√©taill√©e pour l'architecture modulaire

- [2025-10-26] L'extraction des concepts HERMES2022 est r√©alis√©e par un agent JavaScript modulaire ex√©cut√© en **Node.js**, qui articule les requ√™tes HTTP vers les APIs de NuExtract dans le cloud pour analyser et r√©sumer le contenu des pages HTML, puis g√©n√©rer des fichiers JSON structur√©s avec les synth√®ses op√©r√©es.
- [2025-10-26] L'agent est divis√© en modules distincts selon les principes SOLID :
  - __`nuextract-api.js`__ : Couche API/I/O - Appels HTTP purs vers les APIs NuExtract (fonctions pures avec Dependency Injection)
  - __`nuextract-client.js`__ : Couche logique m√©tier - Orchestration, validation, transformation, gestion des fallbacks de configuration
  - __`html-collector-and-transformer.js`__ : Couche collecte HTML - Fetch et conversion HTML‚Üítexte
  - __Snippet racine (`findUp.sync`)__ : √Ä appliquer dans chaque module pour d√©terminer `repoRoot` avant de charger la configuration ou les sch√©mas
- [2025-10-26] L'agent g√®re le cycle complet : chargement configuration, validation cl√© API, chargement instructions, r√©solution et validation sch√©mas JSON, g√©n√©ration template, gestion projet NuExtract.
- [2025-11-09] L'agent est con√ßu pour √™tre modulaire, r√©utilisable et utilise l'√©cosyst√®me npm mature (Ajv, jsonwebtoken, html-to-text, find-up) pour robustesse et maintenabilit√©.

#### Justification pour l'architecture modulaire

- __Separation of Concerns__ : API/I/O s√©par√© de la logique m√©tier et des fallbacks de configuration
- __Single Responsibility Principle (SRP)__ : Chaque module a une responsabilit√© unique et claire
- __Dependency Injection__ : √âlimination du couplage fort via variables globales, toutes les d√©pendances pass√©es en param√®tres
- __Testabilit√©__ : Logique m√©tier testable avec API mock√©e, fonctions pures facilement testables
- __Maintenabilit√©__ : Changements API isol√©s sans impact sur logique m√©tier
- __R√©utilisabilit√©__ : Module API r√©utilisable dans d'autres contextes (pas de d√©pendance √† une config sp√©cifique)
- __√âcosyst√®me Node.js__ : Utilisation de l'√©cosyst√®me npm mature (https, Ajv, jsonwebtoken, html-to-text) pour robustesse et maintenabilit√©
- __Tests BDD complets__ : Framework Jest + jest-cucumber pour validation comportementale
- __Architecture hybride__ : Node.js pour extraction/transformation ‚Üí JSON ‚Üí JArchi pour chargement dans Archi

#### Patterns valid√©s pour l'architecture modulaire

- __Fonctions pures API__ : `async function inferTemplateAsync(hostname, port, path, apiKey, description, timeout) { ... }`
- __Exports normaux API__ : `module.exports = { inferTemplateAsync, getJobStatus, ... }` (interface publique)
- __Exports _testOnly_ client__ : `module.exports = { _testOnly_loadGlobalConfig, _testOnly_generateTemplate, ... }` (logique m√©tier pour tests)
- __Import module API__ : `const nuextractApi = require('./nuextract-api.js')`
- __Appels avec DI__ : `await nuextractApi.inferTemplateAsync(hostname, port, path, apiKey, description, 60)`
- __Fallbacks dans client__ : `const hostname = config?.nuextract?.baseUrl || 'nuextract.ai'`
- __R√©solution chemins__ : `resolveFromRepoRoot(config.nuextract.apiKeyFile)` avec le snippet pr√©sent√© dans @root-directory-governance
- __Requ√™tes HTTP Node.js__ : Utilisation de `https` (module Node.js) pour les appels vers NuExtract
- __Gestion asynchrone__ : Promesses JavaScript pour les requ√™tes non-bloquantes
- __Validation JSON Schema__ : Utilisation de `@apidevtools/json-schema-ref-parser` pour r√©solution des `$ref` et `Ajv` pour validation conformit√© JSON Schema Draft-07
- __Conversion HTML‚Üítexte__ : Utilisation de `html-to-text` pour r√©duire la taille des prompts

#### Anti-Patterns pour l'architecture modulaire √† √©viter

- __Variables globales__ : √âviter GLOBAL_CONFIG dans nuextract-api.js ‚Üí __Solution__ : Param√®tres explicites ‚Üí __R√®gle__ : Dependency Injection
- __Appels internes directs__ : √âviter `await inferTemplateAsync(...)` dans le m√™me module ‚Üí __Solution__ : Import depuis module API ‚Üí __R√®gle__ : S√©paration obligatoire selon SRP
- __Logique m√©tier dans API__ : √âviter la logique de transformation ou fallbacks dans nuextract-api.js ‚Üí __Solution__ : API = HTTP uniquement ‚Üí __R√®gle__ : Separation of Concerns
- __Exports _testOnly_ dans API__ : √âviter dans nuextract-api.js ‚Üí __Solution__ : Exports normaux ‚Üí __R√®gle__ : Interface publique claire
- __God Module__ : √âviter d'ajouter d'autres responsabilit√©s (parsing, validation) dans nuextract-api.js ‚Üí __Solution__ : Cr√©er modules d√©di√©s ‚Üí __R√®gle__ : Single Responsibility
- __D√©pendances npm injustifi√©es__ : √âviter d'ajouter des packages npm sans justification ‚Üí __Solution__ : Utiliser packages standards reconnus (Ajv, jsonwebtoken, html-to-text) ‚Üí __R√®gle √† adopter__ : √âquilibre entre robustesse et simplicit√©
- __Gestion d'erreurs insuffisante__ : √âviter les timeouts infinis ‚Üí __Solution__ : Timeouts explicites ‚Üí __R√®gle √† adopter__ : Robustesse et non-blocage de l'UI

#### √âtat d'impl√©mentation pour l'architecture modulaire

‚úÖ [Fonctionnalit√© r√©alis√©e - 2025-10-26]

- ‚úÖ __Module API__ : `nuextract-api.js` cr√©√© avec 7 fonctions pures (exports normaux)
- ‚úÖ __Module client__ : `nuextract-client.js` refactoris√© (logique m√©tier uniquement, exports `_testOnly_`)
- ‚úÖ __Snippet racine__ : Utilisation standardis√©e du bloc `findUp.sync('package.json', { cwd: __dirname })` selon @root-directory-governance
- ‚úÖ __R√©solution sch√©mas__ : Int√©gration `@apidevtools/json-schema-ref-parser` et `Ajv` pour r√©solution/validation JSON Schema Draft-07

### Int√©gration des APIs NuExtract pour l'extraction structur√©e

#### Description d√©taill√©e pour l'int√©gration des APIs NuExtract

- [2025-10-14] L'agent JavaScript utilise les APIs de NuExtract (mod√®le open source 3.8B bas√© sur Phi-3-mini) pour extraire des donn√©es structur√©es depuis du texte ou HTML vers JSON, garantissant un JSON valide et respectueux des sch√©mas.
- [2025-10-16] Les APIs NuExtact sont d√©crites dans @/home/micwic/gitRepositories/hermes2022-to-archimate/hermes2022-concepts-site-extraction/.cursor/rules/nuextract-platform.yaml
- [2025-10-16] GET /api/projects permet de lister les projets disponibles pour le compte dans dans la plateforme SaaS nuextact.ai, cela permet de d√©terminer {PROJECT_ID} pour HERMES2022 si il existe d√©j√† dans la plateforme SaaS nuextact.ai pour le compte.
- [2025-10-16] La cl√© API valable est stock√©e dans @hermes2022-concepts-site-extraction/config/nuextract-api-key.key
- [2025-10-16] POST /api/projects permet de cr√©er un projet et de d√©terminer {PROJECT_ID} pour HERMES2022 si un tel projet n'existe pas encore dans la plateforme SaaS nuextact.ai. Le projet est cr√©√© avec son template associ√© qui doit exister au pr√©alable dans le format requis par NuExtract
- [2025-10-16] POST /api/infer-template permet de cr√©er un Template NuExtract √† partir d'une description textuelle. Dans le contexte du projet, il faut fusionner les instructions textuelles de @/home/micwic/gitRepositories/hermes2022-to-archimate/hermes2022-concepts-site-extraction/config/instructions-template-nuextract.md avec les formats JSON pertinents, avec y compris les √©ventuelles r√©f√©rences (Exemple : "phases": {"$ref": "./hermes2022-phases.json"}) dans un seul format JSON homog√®ne.
- [2025-10-16] PUT /api/projects/{projectId}/template permet de mettre √† jour le template pour un projet d√©j√† existant
- [2025-10-17] POST /api/projects/{projectId}/infer-text permet d'ex√©cuter une extraction sur la base d'un texte dans le cadre fix√© pour le projet √† savoir sur la base d'un template NuExtract et des exemples de transformation fournis pour les param√®tres d√©finis. Dans le contexte du projet, il faut fusionner les instructions textuelles conform√©ment √† la s√©quence d√©finie dans @hermes2022-concepts-site-extraction/config/extraction-hermes2022-main.md avec avec les contenus HTML extrait des pages de r√©f√©rences correspondantes
- [2025-10-14] Gestion des quotas : L'API supporte des requ√™tes gratuites avec limites (ex. : 1000 requ√™tes/mois), et payantes pour plus de volume ; l'agent inclut un suivi des usages.

#### Justification pour l'int√©gration des APIs NuExtract

- __Pr√©cision et Fiabilit√©__ : Mod√®le sp√©cialis√© pour extraction HTML‚ÜíJSON, surpassant les mod√®les g√©n√©ralistes pour cette t√¢che, avec validation automatique du JSON.
- __S√©curit√© et Conformit√©__ : Utilisation de la cl√© API personnelle (pas de stockage sensible externe), respect des licences MIT et lois suisses.
- __APIs REST simples__ : Compatible avec Node.js (https) et potentiellement JArchi (java.net.http.HttpClient) pour consommation des fichiers JSON
- __√âvolutivit√©__ : Support de sch√©mas personnalis√©s pour diff√©rents concepts HERMES2022, et possibilit√© d'extension √† d'autres mod√®les IA.

#### Patterns valid√©s pour l'int√©gration des APIs NuExtract

- __Authentification Bearer__ : Utilisation de l'en-t√™te `Authorization: Bearer <cl√© JWT>` pour s√©curiser les requ√™tes avec la cl√© d√©finie dans @hermes2022-concepts-site-extraction/config/nuextract-api-key.key
- __Gestion des Quotas__ : Impl√©mentation d'un compteur d'usage dans l'agent, avec logging pour √©viter les d√©passements.
- __Validation de R√©ponse__ : Parsing de la r√©ponse JSON avec v√©rification des erreurs (ex. : code 429 pour quota d√©pass√©).

#### Anti-Patterns pour l'int√©gration des APIs NuExtract √† √©viter

- __Utilisation sans authentification__ : √âviter les requ√™tes non authentifi√©es ‚Üí __Solution__ : Toujours inclure la cl√© Bearer ‚Üí __R√®gle √† adopter__ : S√©curit√© des acc√®s API.
- __D√©passement de quotas__ : √âviter les requ√™tes excessives ‚Üí __Solution__ : Suivi et limites ‚Üí __R√®gle √† adopter__ : Gestion proactive des ressources.
- __Hardcodage de la cl√©__ : √âviter de coder la cl√© en dur ‚Üí __Solution__ : Variable d'environnement ou config ‚Üí __R√®gle √† adopter__ : S√©curit√© et maintenabilit√©.

#### √âtat d'impl√©mentation pour l'int√©gration des APIs NuExtract

‚úÖ [Int√©gration r√©alis√©e dans nuextract-api.js - 2025-10-26]

- ‚úÖ __7 fonctions API__ : inferTemplateFromDescription, inferTemplateFromDescriptionAsync, getJobStatus, pollJobUntilComplete, getNuExtractProjects, createNuExtractProject, putProjectTemplate
- ‚úÖ __Gestion timeouts__ : Timeouts explicites pour toutes les requ√™tes HTTP (sync: 35s, async: 10s, jobs: 5s, projects: 10s)
- ‚úÖ __Authentification Bearer__ : En-t√™te `Authorization: Bearer <cl√© JWT>` sur toutes les requ√™tes
- ‚úÖ __Gestion erreurs__ : Messages d'erreur contextualis√©s avec Error Cause (ES2022) pour pr√©server stack trace

### Conversion HTML‚Üítexte avec html-to-text

#### Description d√©taill√©e pour la conversion HTML‚Üítexte

- [2025-11-10] La conversion HTML‚Üítexte utilise exclusivement la biblioth√®que `html-to-text` (pas de Cheerio)
- [2025-11-10] La configuration est optimis√©e sp√©cifiquement pour la structure HTML de `hermes.admin.ch` identifi√©e par analyse du HTML r√©el
- [2025-11-10] Les s√©lecteurs ciblent le contenu principal (`main`, `.container__main`, `.vertical-spacing`) et ignorent les √©l√©ments non pertinents (navigation, footer, sidebar, metadata, images)
- [2025-11-10] La structure s√©mantique est pr√©serv√©e (titres H1/H2/H3 avec hi√©rarchie, paragraphes, listes) pour faciliter l'interpr√©tation par l'IA NuExtract

#### Justification pour la conversion HTML‚Üítexte

- __R√©duction taille prompts__ : √âlimination du bruit HTML (navigation, footer, sidebar, images, scripts) r√©duit significativement la taille des prompts envoy√©s √† NuExtract
- __Pr√©servation s√©mantique__ : Structure hi√©rarchique des titres et paragraphes pr√©serv√©e pour maintenir le contexte et la logique du contenu HERMES2022
- __Simplicit√© architecture__ : Utilisation de `html-to-text` uniquement (pas de Cheerio) pour √©viter la complexit√© et respecter l'√©cosyst√®me npm minimal
- __Configuration sp√©cifique__ : S√©lecteurs adapt√©s √† la structure HTML r√©elle de `hermes.admin.ch` (analys√©e via logs d'ex√©cution)

#### Patterns valid√©s pour la conversion HTML‚Üítexte

```javascript
const textContent = convert(data, {
  wordwrap: false,
  preserveNewlines: true,
  
  // Cibler le contenu principal
  baseElements: {
    selectors: ['main', '.container__main', '.vertical-spacing']
  },
  
  selectors: [
    // Ignorer navigation et UI
    { selector: 'header', format: 'skip' },
    { selector: 'nav', format: 'skip' },
    { selector: 'footer', format: 'skip' },
    { selector: '.top-bar', format: 'skip' },
    { selector: '.breadcrumb', format: 'skip' },
    { selector: '.main-navigation', format: 'skip' },
    { selector: '.mobile-menu', format: 'skip' },
    { selector: '.language-switcher', format: 'skip' },
    { selector: '.search', format: 'skip' },
    { selector: '.burger', format: 'skip' },
    { selector: '.back-to-top-btn', format: 'skip' },
    { selector: '.container__aside', format: 'skip' },
    
    // Ignorer metadata
    { selector: 'script', format: 'skip' },
    { selector: 'style', format: 'skip' },
    { selector: 'noscript', format: 'skip' },
    
    // Ignorer images et SVG
    { selector: 'img', format: 'skip' },
    { selector: 'svg', format: 'skip' },
    { selector: 'picture', format: 'skip' },
    
    // Pr√©server structure s√©mantique
    { selector: 'h1', options: { uppercase: false, leadingLineBreaks: 2, trailingLineBreaks: 1 } },
    { selector: 'h2', options: { uppercase: false, leadingLineBreaks: 2, trailingLineBreaks: 1 } },
    { selector: 'h3', options: { uppercase: false, leadingLineBreaks: 1, trailingLineBreaks: 1 } },
    { selector: 'p', format: 'paragraph' },
    { selector: 'ul', format: 'unorderedList' },
    { selector: 'ol', format: 'orderedList' },
    { selector: 'a', options: { ignoreHref: true } }
  ]
});
```

#### Anti-Patterns pour la conversion HTML‚Üítexte √† √©viter

- __Cheerio__ : √âviter d'ajouter Cheerio pour nettoyage HTML ‚Üí __Solution__ : Utiliser s√©lecteurs `html-to-text` uniquement ‚Üí __R√®gle √† adopter__ : Simplicit√© et √©cosyst√®me npm minimal
- __Configuration g√©n√©rique__ : √âviter configuration basique sans s√©lecteurs ‚Üí __Solution__ : Configuration sp√©cifique √† `hermes.admin.ch` ‚Üí __R√®gle √† adopter__ : Analyse HTML r√©el pour optimisation
- __Perte structure s√©mantique__ : √âviter conversion plate sans hi√©rarchie ‚Üí __Solution__ : Pr√©server titres H1/H2/H3 avec espacement ‚Üí __R√®gle √† adopter__ : Structure s√©mantique pour IA

#### √âtat d'impl√©mentation pour la conversion HTML‚Üítexte

‚úÖ [Configuration appliqu√©e dans html-collector-and-transformer.js - 2025-11-10]

- ‚úÖ __S√©lecteurs sp√©cifiques__ : Configuration adapt√©e √† la structure HTML de `hermes.admin.ch`
- ‚úÖ __Contenu principal cibl√©__ : `baseElements` avec `main`, `.container__main`, `.vertical-spacing`
- ‚úÖ __Bruit √©limin√©__ : Navigation, footer, sidebar, metadata, images ignor√©s
- ‚úÖ __Structure pr√©serv√©e__ : Titres H1/H2/H3, paragraphes, listes avec espacement s√©mantique

### Validation de la cl√© API avec jsonwebtoken

#### Description d√©taill√©e pour la validation de la cl√© API

- [2025-10-25] La cl√© API NuExtract est valid√©e avec la biblioth√®que `jsonwebtoken` pour s'assurer qu'elle respecte le format JWT standard attendu par l'API
- [2025-10-25] La validation utilise `jwt.decode()` avec l'option `{ complete: true }` pour d√©coder le JWT sans v√©rifier la signature (pas besoin de la cl√© publique de NuExtract)
- [2025-10-25] La validation v√©rifie :
  - Que le JWT contient bien 3 parties (header, payload, signature)
  - Que le header et le payload sont d√©codables en JSON valide
  - Que le header contient les champs requis `typ` et `alg`
- [2025-10-25] Cette validation est effectu√©e apr√®s le trim de la cl√© et avant toute utilisation pour appel API
- [2025-10-25] En cas d'erreur de validation, un message explicite est retourn√© : `API key format is invalid: {d√©tail erreur}. Script stopped.`

#### Justification pour la validation de la cl√© API

- __Validation robuste__ : D√©tecte les JWT mal form√©s avant l'appel API (√©vite les requ√™tes inutiles avec cl√©s invalides comme `"1234"` ou `"a.b.c"`)
- __Standard de l'industrie__ : `jsonwebtoken` est la biblioth√®que de r√©f√©rence pour JWT en Node.js (50M t√©l√©chargements/semaine)
- __Pas de cl√© publique n√©cessaire__ : Le d√©codage sans v√©rification de signature suffit pour valider la structure
- __S√©curit√©__ : D√©tection pr√©coce des erreurs de configuration (cl√© corrompue, fichier mal format√©)
- __Taille acceptable__ : ~50KB de d√©pendance, n√©gligeable compar√© √† Jest/Babel d√©j√† pr√©sents

#### Patterns valid√©s pour la validation de la cl√© API

- __D√©codage sans v√©rification__ : Utilisation de `jwt.decode(apiKey, { complete: true })` au lieu de `jwt.verify()`
- __Validation structurelle__ : V√©rification que `decoded.header` et `decoded.payload` existent
- __Validation des champs requis__ : V√©rification que `decoded.header.typ` et `decoded.header.alg` sont pr√©sents
- __Gestion d'erreur__ : Encapsulation dans try-catch avec message explicite
- __S√©quence de validation__ :
  1. Chargement de la cl√© (env var ou fichier)
  2. Trim des espaces
  3. V√©rification non vide
  4. Validation format JWT avec `jsonwebtoken`

#### Anti-Patterns pour la validation de la cl√© API √† √©viter

- __Validation simple par split__ : √âviter `apiKey.split('.').length === 3` qui accepte `"a.b.c"` ‚Üí __Solution__ : Utiliser `jsonwebtoken` ‚Üí __R√®gle √† adopter__ : Validation structurelle compl√®te
- __V√©rification de signature__ : √âviter `jwt.verify()` qui n√©cessite la cl√© publique ‚Üí __Solution__ : Utiliser `jwt.decode()` ‚Üí __R√®gle √† adopter__ : D√©codage sans v√©rification suffit
- __Validation manuelle base64__ : √âviter de r√©inventer la roue avec Buffer.from() ‚Üí __Solution__ : Utiliser `jsonwebtoken` ‚Üí __R√®gle √† adopter__ : Utiliser biblioth√®que standard
- __Hardcodage JWT test__ : √âviter les JWT de test cod√©s en dur dans le code ‚Üí __Solution__ : Mocks dans les tests uniquement ‚Üí __R√®gle √† adopter__ : Configuration externe pour production

#### √âtat d'impl√©mentation pour la validation de la cl√© API

‚úÖ [Fonctionnalit√© r√©alis√©e]

- ‚úÖ __Installation__ : `jsonwebtoken` 9.0.2 ajout√© aux devDependencies
- ‚úÖ __Impl√©mentation__ : Validation dans `loadApiKey()` de `nuextract-client.js`
- ‚úÖ __Tests BDD__ : 4 sc√©narios passent (cl√© absente, cl√© vide, JWT invalide, chargement r√©ussi)

### R√©solution et validation des sch√©mas JSON

#### Description d√©taill√©e pour la r√©solution et validation des sch√©mas

- [2025-10-28] Les sch√©mas JSON avec r√©f√©rences `$ref` sont r√©solus et valid√©s avant utilisation pour g√©n√©ration de template
- [2025-10-28] __R√©solution des r√©f√©rences__ : Utilisation de `@apidevtools/json-schema-ref-parser` pour r√©soudre automatiquement toutes les r√©f√©rences `$ref` dans un sch√©ma JSON monolithique
- [2025-10-28] __Validation conformit√©__ : Utilisation de `Ajv` (avec `ajv-formats`) pour valider que le sch√©ma r√©solu est conforme √† JSON Schema Draft-07 (standard utilis√© dans le projet)
- [2025-10-28] Le sch√©ma r√©solu et valid√© est ensuite fusionn√© avec les instructions textuelles pour cr√©er la description envoy√©e √† l'API NuExtract
- [2025-10-28] Les erreurs de r√©solution ou validation sont contextualis√©es avec Error Cause (ES2022) pour pr√©server la tra√ßabilit√©

#### Justification pour la r√©solution et validation des sch√©mas

- __Modularit√©__ : Permet de s√©parer les sch√©mas en fichiers distincts avec r√©f√©rences `$ref` pour faciliter la maintenance
- __Validation stricte__ : Garantit que le sch√©ma respecte le standard JSON Schema Draft-07 avant utilisation
- __Tra√ßabilit√©__ : Erreurs contextualis√©es avec Error Cause pour faciliter le d√©bogage
- __Standard reconnu__ : `@apidevtools/json-schema-ref-parser` est la biblioth√®que standard pour r√©solution de r√©f√©rences JSON Schema
- __Validation robuste__ : `Ajv` est la biblioth√®que de r√©f√©rence pour validation JSON Schema en JavaScript

#### Patterns valid√©s pour la r√©solution et validation des sch√©mas

- __R√©solution r√©f√©rences__ : `const resolvedSchema = await $RefParser.dereference(mainSchemaFile, { dereference: { circular: 'ignore' } })`
- __Validation Draft-07__ : `const metaSchema = require('ajv/dist/refs/json-schema-draft-07.json')` puis `ajv.compile(metaSchema)`
- __Gestion erreurs__ : `throw new Error('Invalid JSON schema structure or content. Script stopped.', { cause: error })`
- __S√©quence__ : R√©solution `$ref` ‚Üí Validation conformit√© ‚Üí Stringify pour fusion avec instructions

#### Anti-Patterns pour la r√©solution et validation des sch√©mas √† √©viter

- __R√©solution manuelle__ : √âviter de r√©soudre manuellement les `$ref` avec boucles custom ‚Üí __Solution__ : Utiliser `@apidevtools/json-schema-ref-parser` ‚Üí __R√®gle √† adopter__ : Biblioth√®que standard
- __Validation absente__ : √âviter d'utiliser un sch√©ma non valid√© ‚Üí __Solution__ : Toujours valider avec Ajv ‚Üí __R√®gle √† adopter__ : Validation obligatoire
- __Perte tra√ßabilit√©__ : √âviter `throw new Error(error.message)` qui perd la stack ‚Üí __Solution__ : Utiliser Error Cause ‚Üí __R√®gle √† adopter__ : Error Cause pour wrapping

#### √âtat d'impl√©mentation pour la r√©solution et validation des sch√©mas

‚úÖ [Fonctionnalit√© r√©alis√©e - 2025-10-28]

- ‚úÖ __Biblioth√®que r√©solution__ : `@apidevtools/json-schema-ref-parser` install√©e et int√©gr√©e
- ‚úÖ __Biblioth√®que validation__ : `Ajv` + `ajv-formats` install√©es et int√©gr√©es
- ‚úÖ __Fonction loadAndResolveSchemas__ : Refactoris√©e dans `nuextract-client.js` avec r√©solution et validation
- ‚úÖ __Tests BDD__ : 4 sc√©narios passent (sch√©ma manquant, `$ref` manquant, JSON malform√©, sch√©ma non conforme)

### Gestion des modes de g√©n√©ration de template (sync/async)

#### Description d√©taill√©e pour la gestion des modes

- [2025-10-24] L'extraction supporte deux modes de g√©n√©ration de template via le param√®tre `templateMode` dans `extraction-config.json`
- [2025-10-24] __Mode sync__ : Utilise `/api/infer-template` - traitement synchrone avec timeout HTTP global
- [2025-10-24] __Mode async__ : Utilise `/api/infer-template-async` - traitement asynchrone avec polling de statut
- [2025-10-24] __Constat empirique__ : L'API synchrone timeout √† ~11 secondes avec le sch√©ma `hermes2022-concepts.json` (4442 caract√®res) et retourne erreur 206 (Partial Content) avec body vide `{}`, tandis que l'API asynchrone permet de traiter le m√™me sch√©ma en 44 secondes avec succ√®s
- [2025-10-24] __Param√®tre unifi√© `templateGenerationDuration`__ : Repr√©sente le temps estim√© de g√©n√©ration (d√©faut 30000ms)
  - __Mode sync__ : Utilis√© comme base pour le timeout HTTP avec marge de s√©curit√© = `templateGenerationDuration + 5000`
  - __Mode async__ : Utilis√© comme sleep initial avant le polling = `templateGenerationDuration`
- [2025-10-24] Le template g√©n√©r√© est sauvegard√© dans `shared/hermes2022-extraction-files/config/nuextract-template-generated/nuextract-template.json`

#### Justification pour la gestion des modes

- __Flexibilit√©__ : Permet de choisir entre rapidit√© (sync pour petits sch√©mas) et fiabilit√© (async pour sch√©mas complexes >4000 caract√®res)
- __R√©sout les timeouts__ : Le mode async r√©sout les timeouts syst√©matiques avec des sch√©mas JSON complexes
- __Gestion d'erreur explicite__ : Message d'erreur clair en cas de timeout sync proposant de passer en mode async

#### Patterns valid√©s pour la gestion des modes

- __Param√®tre `templateMode`__ : Valeurs accept√©es "sync" ou "async" (d√©faut "sync" si absent)
- __Param√®tre `templateGenerationDuration`__ : Temps estim√© en ms (d√©faut 30000)
- __Param√®tres d'endpoints__ : `infer-templatePath` et `infer-templateAsyncPath` dans configuration
- __Mode sync__ :
  - Timeout HTTP = `templateGenerationDuration + 5000` ms
  - Pas de sleep, pas de retry
  - Template retourn√© directement dans la r√©ponse
  - Message d'erreur timeout explicite : "Timeout sync apr√®s Xms. Pour sch√©mas >4000 caract√®res, utilisez templateMode: 'async'"
- __Mode async__ :
  - Timeout param√®tre API = 60 secondes (`?timeout=60s`)
  - Sleep initial = `templateGenerationDuration` ms
  - Polling interval = 3 secondes entre chaque v√©rification
  - Max attempts = 20 tentatives de polling
  - Workflow : POST `/api/infer-template-async?timeout=60s` ‚Üí obtenir jobId ‚Üí sleep ‚Üí polling GET `/api/jobs/{jobId}` ‚Üí r√©cup√©rer outputData
  - Statuts accept√©s : `"completed"` (succ√®s normal) ET `"timeout"` (succ√®s avec d√©passement timeout mais outputData pr√©sent)
  - Statut √©chec : `"failed"` (√©chec du job)
- __Format description__ : Sch√©ma JSON en premier, puis instructions (sans headers/commentaires) ‚Äî Les instructions plac√©es avant le sch√©ma perturbent la g√©n√©ration du template
- __Limite taille__ : 32k caract√®res pour le champ `description` selon support NuMind

#### Anti-Patterns pour la gestion des modes √† √©viter

- __Mode invalide__ : √âviter templateMode ni "sync" ni "async" ‚Üí __Solution__ : Validation stricte ‚Üí __R√®gle √† adopter__ : Lever erreur explicite si valeur invalide
- __Utiliser mode sync pour sch√©mas >4000 caract√®res__ : √âviter `/api/infer-template` pour gros sch√©mas ‚Üí __Solution__ : Utiliser mode async ‚Üí __R√®gle √† adopter__ : Workflow async pour sch√©mas complexes
- __Polling imm√©diat (async)__ : √âviter de poller d√®s la soumission ‚Üí __Solution__ : Sleep `templateGenerationDuration` initial ‚Üí __R√®gle √† adopter__ : Laisser le temps au job de s'initialiser
- __Polling trop rapide (async)__ : √âviter interval <2s ‚Üí __Solution__ : Interval 3s ‚Üí __R√®gle √† adopter__ : Limiter la charge sur l'API
- __Instructions avant sch√©ma__ : √âviter headers/instructions avant le sch√©ma JSON ‚Üí __Solution__ : Sch√©ma d'abord, instructions apr√®s ‚Üí __R√®gle √† adopter__ : Format description = sch√©ma + instructions (sans headers)

#### √âtat d'impl√©mentation pour la gestion des modes

‚úÖ [Fonctionnalit√© r√©alis√©e]

### G√©n√©ration de template depuis configuration JSON centralis√©e

#### Description d√©taill√©e pour la g√©n√©ration de template depuis configuration JSON centralis√©e

- [2025-11-01] Les instructions de g√©n√©ration de template NuExtract sont d√©sormais centralis√©es dans `extraction-config.schema.json` sous `nuextract.templateTransformationInstructions`
- [2025-11-01] Le sch√©ma JSON Schema d√©finit toutes les valeurs possibles via le pattern `enum` (propri√©t√©s simples) et `items.enum` (arrays)
- [2025-11-01] La transformation sch√©ma ‚Üí config est r√©alis√©e par `transformSchemaToConfig()` qui extrait les valeurs par d√©faut depuis les `enum`
- [2025-11-01] Le config transform√© est valid√© avec Ajv avant utilisation pour garantir la conformit√© au sch√©ma
- [2025-11-01] Les instructions sont extraites directement depuis la config en m√©moire (`config.nuextract.templateTransformationInstructions.instructions`)
- [2025-11-01] SRP strict : Les instructions de g√©n√©ration de template font partie de l'impl√©mentation technique NuExtract, donc dans `extraction-config.schema.json` sous `nuextract`, PAS dans le sch√©ma conceptuel

#### Justification pour la g√©n√©ration de template depuis configuration JSON centralis√©e

- __Centralisation__ : Configuration technique centralis√©e dans un seul fichier sch√©ma selon SRP
- __Param√©trage structur√©__ : Pattern `enum` pour d√©finir toutes les valeurs possibles sans duplication
- __Type safety__ : Validation JSON Schema avec Ajv garantit la conformit√© avant utilisation
- __Simplicit√©__ : Plus de parsing Markdown, extraction directe depuis config en m√©moire
- __Historisation__ : Le fichier `extraction-config.json` sera cr√©√© dans le r√©pertoire des donn√©es apr√®s extraction pour tra√ßabilit√©

#### Patterns valid√©s pour la g√©n√©ration de template depuis configuration JSON centralis√©e

- __Sch√©ma source__ : `extraction-config.schema.json` avec toutes les propri√©t√©s et leurs `enum` possibles
- __Transformation__ : `transformSchemaToConfig(schema)` qui parcourt r√©cursivement les propri√©t√©s
- __Pattern enum__ :
  - __Propri√©t√©s simples__ : `property.enum[0]` = valeur par d√©faut
  - __Arrays__ : `property.items.enum` (array complet) = valeur par d√©faut
- __Validation Ajv__ : Config transform√© valid√© avec le sch√©ma avant utilisation
- __Extraction instructions__ : `config.nuextract.templateTransformationInstructions.instructions` (array joint avec `\n`)
- __Localisation SRP__ : `templateTransformationInstructions` dans `extraction-config.schema.json` sous `nuextract`, PAS dans sch√©ma conceptuel

#### Anti-Patterns pour la g√©n√©ration de template depuis configuration JSON centralis√©e √† √©viter

- __Instructions dans sch√©ma conceptuel__ : √âviter de placer `templateTransformationInstructions` dans `hermes2022-concepts.json` ‚Üí __Solution__ : Configuration technique dans `extraction-config.schema.json` ‚Üí __R√®gle √† adopter__ : SRP strict
- __Parsing Markdown__ : √âviter de charger et parser `instructions-template-nuextract.md` ‚Üí __Solution__ : Extraction depuis config en m√©moire ‚Üí __R√®gle √† adopter__ : Pas de parsing inutile
- __Default JSON Schema__ : √âviter d'utiliser `default` dans le sch√©ma ‚Üí __Solution__ : Pattern `enum` uniquement ‚Üí __R√®gle √† adopter__ : Enum comme source unique
- __Redondance enum__ : √âviter de dupliquer les valeurs entre `enum` et `default` ‚Üí __Solution__ : Uniquement `enum`, transformation manuelle ‚Üí __R√®gle √† adopter__ : DRY

#### √âtat d'impl√©mentation pour la g√©n√©ration de template depuis configuration JSON centralis√©e

‚úÖ [Migration r√©alis√©e - 2025-11-01]

- ‚úÖ __Sch√©ma JSON Schema__ : `extraction-config.schema.json` cr√©√© avec structure compl√®te et instructions migr√©es
- ‚úÖ __Fonction transformation__ : `transformSchemaToConfig()` impl√©ment√©e avec logique enum[0] vs items.enum
- ‚úÖ __loadGlobalConfig()__ : Modifi√© pour lire sch√©ma, transformer et valider avec Ajv
- ‚úÖ __loadInstructions()__ : Modifi√© pour extraire depuis config en m√©moire (plus de parsing Markdown)
- ‚úÖ __Tests BDD__ : Tous les tests unitaires et d'int√©gration passent (24/24 unitaires, 6/6 int√©gration)
- ‚úÖ __Nettoyage__ : Fichiers obsol√®tes `instructions-template-nuextract.md` et `extraction-config.json` supprim√©s

### Cycle de vie de projet NuExtract

#### Description d√©taill√©e pour le cycle de vie de projet NuExtract

- 2025-10-24 Un projet est cr√©√© automatiquement par l'agent sp√©cialis√© Javascript si il n'existe pas encore sur la plateforme SaaS NuExtract pour le compte qui correspond √† la cl√© API configur√©e
- 2025-10-24 Le projet existant sur la plateforme SaaS NuExtract pour le compte qui correspond √† la cl√© API configur√©e qui correspond √† la d√©finition configur√©e est r√©utilis√©
- 2025-10-24 Le param√®tre `templateReset` dans `extraction-config.json` contr√¥le si le template d'un projet existant doit √™tre mis √† jour :
  - `templateReset: true` ‚Üí Le template est mis √† jour avec `putProjectTemplate` si le projet existe d√©j√†
  - `templateReset: false` ‚Üí Aucune mise √† jour, le projet existant est retourn√© tel quel
- 2025-10-24 La suppression de projet s'effectue sur la plateforme SaaS NuExtract pour le compte qui correspond √† la cl√© API configur√©e, elle n'est pas int√©gr√©e dans l'agent sp√©cialis√© Javascript

#### Justification pour le cycle de vie de projet NuExtract

- __Automatisation__ : √âvite la cr√©ation manuelle de projets sur la plateforme SaaS
- __R√©utilisabilit√©__ : Permet de r√©utiliser un projet existant avec son template et ses exemples
- __Simplicit√©__ : Centralise la gestion dans l'agent JavaScript
- __S√©curit√©__ : La suppression reste une op√©ration manuelle pour √©viter les pertes de donn√©es accidentelles

#### Patterns valid√©s pour le cycle de vie de projet NuExtract

- __Recherche avant cr√©ation__ : Utiliser `getNuExtractProjects()` pour v√©rifier l'existence avant cr√©ation
- __Fonction unifi√©e__ : `findOrCreateProject(apiKey, projectName, projectDescription, templateObj, templateReset)` g√®re automatiquement la recherche, cr√©ation et mise √† jour
- __Param√®tres configurables__ : `projectName`, `projectDescription` et `templateReset` d√©finis dans `extraction-config.json`
- __Template obligatoire__ : Un template est obligatoire pour la cr√©ation d'un nouveau projet, une erreur est lev√©e si `templateObj` est `null`
- __Contr√¥le mise √† jour__ : Le param√®tre `templateReset` (boolean) d√©termine si le template d'un projet existant doit √™tre mis √† jour
- __Mise √† jour template__ : `putProjectTemplate(apiKey, projectId, template)` appel√© automatiquement si `templateReset=true` et projet existant
- __Correspondance par nom__ : Le projet est identifi√© par son nom (`projectName`) sur la plateforme
- __Retour structur√©__ : La fonction retourne un objet `{ id, name, created?, updated? }` indiquant l'action effectu√©e

#### Anti-Patterns pour le cycle de vie de projet NuExtract √† √©viter

- __Cr√©ation sans v√©rification__ : √âviter de cr√©er un projet sans v√©rifier son existence ‚Üí __Solution__ : Utiliser `findOrCreateProject()` ‚Üí __R√®gle √† adopter__ : Recherche syst√©matique avant cr√©ation
- __Cr√©ation sans template__ : √âviter de cr√©er un projet sans template ‚Üí __Solution__ : Toujours fournir un template valide ‚Üí __R√®gle √† adopter__ : Template obligatoire pour cr√©ation
- __Suppression automatique__ : √âviter la suppression programmatique de projets ‚Üí __Solution__ : Suppression manuelle uniquement ‚Üí __R√®gle √† adopter__ : Pr√©server les projets et leurs exemples sur la plateforme
- __Hardcodage du nom__ : √âviter de coder en dur le nom du projet ‚Üí __Solution__ : Param√©trer dans configuration ‚Üí __R√®gle √† adopter__ : Utiliser `extraction-config.json`
- __Ignorer templateReset__ : √âviter de toujours mettre √† jour ou jamais mettre √† jour ‚Üí __Solution__ : Respecter le param√®tre `templateReset` ‚Üí __R√®gle √† adopter__ : Contr√¥le explicite via configuration

#### √âtat d'impl√©mentation pour le cycle de vie de projet NuExtract

üöß [Fonctions impl√©ment√©es, tests BDD √† compl√©ter]

### Structure et format des instructions d'extraction

#### Description d√©taill√©e pour la structure et format des instructions d'extraction

- [2025-08-16] Les instructions d'extraction utilisent le format Markdown pour optimiser l'utilisation par l'IA
- [2025-08-16] Un fichier d'instructions s√©par√© est cr√©√© pour chaque concept HERMES2022 √† extraire (phases, sc√©narios, modules, t√¢ches, r√©sultats, r√¥les)
- [2025-08-16] Les instructions se concentrent uniquement sur la transformation, pas sur la d√©finition de la structure cible
- [2025-08-16] La structure cible est d√©finie par les sch√©mas JSON des fichiers interm√©diaires, cr√©ant un contrat d'interface entre extraction et consommation
- [2015-10-18] Les pages html de r√©f√©rence pour un concept sont d√©clar√©es dans une propri√©t√© sourceURL de type caract√®re associ√©e √† une √©num√©ration pour la liste qui est √† concat√©n√©e pour la former la cha√Æne de caract√®re √† l'ex√©cution pour journaliser les pages effectivement utilis√©es lors de la cr√©ation du fichier interm√©diaire. Le sch√©ma JSON sert √† la fois de d√©finition de la propri√©t√© de journalisation et de param√®tre avec l'√©num√©ration.

#### Justification pour la structure et format des instructions d'extraction

- __Format Markdown__ : Naturel pour l'IA, instructions conversationnelles claires
- __Fichiers s√©par√©s__ : Maintenance facilit√©e, lisibilit√© optimale, √©volution ind√©pendante par concept
- __S√©paration des responsabilit√©s__ : Instructions d'extraction ‚â† d√©finition structure cible
- __Contrat d'interface__ : Synchronisation progressive entre instructions et sch√©mas cibles

#### Patterns valid√©s pour la structure et format des instructions d'extraction

- __Un fichier par concept__ : `/config/extraction-{concept}.md` pour chaque concept HERMES2022
- __Instructions conversationnelles__ : Prompts naturels adapt√©s √† l'IA
- __Synchronisation progressive__ : √âvolution conjointe des instructions et des sch√©mas cibles
- __Validation par sch√©ma__ : Contr√¥le de conformit√© via JSON Schema des fichiers interm√©diaires

#### Anti-Patterns pour la structure et format des instructions d'extraction √† √©viter

- __Fichier monolithique__ : √âviter un seul fichier pour tous les concepts ‚Üí __Solution__ : Fichiers s√©par√©s par concept ‚Üí __R√®gle √† adopter__ : Modularit√© conceptuelle
- __M√©lange des responsabilit√©s__ : √âviter de d√©finir la structure cible dans les instructions ‚Üí __Solution__ : S√©paration claire extraction/structure ‚Üí __R√®gle √† adopter__ : Contrat d'interface via sch√©mas
- __Format technique__ : √âviter JSON/YAML pour les instructions ‚Üí __Solution__ : Markdown conversationnel ‚Üí __R√®gle √† adopter__ : Instructions naturelles pour l'IA

#### √âtat d'impl√©mentation pour la structure et format des instructions d'extraction

üöß [En cours de conception et r√©alisation]

### Contrat d'interface extraction-fichiers interm√©diaires

#### Description d√©taill√©e pour le contrat d'interface

- [2025-08-16] Un contrat d'interface est √©tabli entre les instructions d'extraction et les sch√©mas des fichiers interm√©diaires, il consiste surtout √† v√©rifier et faire se synchroniser les d√©finitions dans les sp√©cifications respectives par l'IA
- [2025-08-16] La synchronisation se fait progressivement au fur et √† mesure de l'√©volution des besoins
- [2025-08-16] Les sch√©mas JSON des fichiers interm√©diaires d√©finissent la structure cible de la transformation

#### Justification pour le contrat d'interface

- __Coh√©rence__ : Garantit l'alignement entre extraction et consommation
- __√âvolutivit√©__ : Permet l'adaptation progressive des deux c√¥t√©s
- __Validation__ : Assure la conformit√© des donn√©es extraites
- __Maintenance__ : Facilite la gestion des changements

#### Patterns valid√©s pour le contrat d'interface

- __Synchronisation progressive__ : √âvolution conjointe des instructions et sch√©mas
- __Validation automatique__ : Contr√¥le de conformit√© via JSON Schema
- __Documentation partag√©e__ : R√©f√©rence commune pour l'√©quipe

#### √âtat d'impl√©mentation pour le contrat d'interface

üöß [En cours de sp√©cification et r√©alisation]

### Visa humain d'overview pour hermes2022-concepts

#### Description d√©taill√©e pour le visa humain d'overview

- [2025-08-19] La qualit√© du champ `overview` des concepts HERMES2022 est valid√©e manuellement via un fichier d'approbation (sidecar) adjacent √† l'artefact JSON produit.
- [2025-08-19] Le visa est consign√© par √©l√©ments/r√®gles √† contr√¥ler (statuts par item) avec des m√©tadonn√©es globales uniques (reviewer, date, notes).

#### Justification pour le visa humain d'overview

- La conformit√© structurelle est assur√©e par JSON Schema; la qualit√© s√©mantique de `overview` requiert un jugement humain.
- La mat√©rialisation explicite du visa am√©liore la tra√ßabilit√© et l'auditabilit√© sans sur‚Äëing√©nierie.

#### Patterns valid√©s pour le visa humain d'overview

- __Sidecar d'approbation__: Fichier sidecar adjacent nomm√© comme l'artefact avec suffixe `.approval.json` g√©n√©r√© par l'IA en post extraction
- __Sch√©ma d'approbation__: `shared/hermes2022-extraction-files/config/json-schemas/hermes2022-concepts-approval.json`.
- __Structure du visa__:
  - M√©tadonn√©es globales: `artifact`, `reviewer`, `date`, `notes?`.
  - D√©tails par item: `target`, `rule`, `status` (`approved|rejected|pending`), `lastChecked`, `comment?`, `evidence?`.
- __Initialisation status approbation__ : Cible √† valider g√©n√©r√©es selon liste ci-dessous avec status "pending" pour les cibles √† valider en post extraction

__Cibles √† valider par revue humaine (format JSON Pointer)__ :

- `/concepts/overview`

#### Anti-Patterns pour le visa humain d'overview √† √©viter

- __Visa global unique__: √©viter un statut global sans granularit√© par r√®gle/cible.
- __Absence de sch√©ma__: √©viter des fichiers d'approbation non valid√©s.

#### √âtat d'impl√©mentation pour le visa humain d'overview

‚úÖ Sch√©ma d'approbation cr√©√©: `shared/hermes2022-extraction-files/config/json-schemas/hermes2022-concepts-approval.json`
üöß Int√©gration dans le flux d'extraction/validation BDD √† compl√©ter

### Param√©trage du r√©pertoire des artefacts (artifactBaseDir)

#### Description d√©taill√©e

- [2025-08-20] Ajout d‚Äôune propri√©t√© `artifactBaseDir` dans `config/extraction-config.json` pour orienter l‚Äôoutillage (tests BDD inclus) vers un r√©pertoire unique d‚Äôartefacts sans recherche multiple.
- Valeur: chemin relatif au r√©pertoire `hermes2022-concepts-site-extraction/` (chemin absolu accept√©).
- Objectif: permette l'ex√©cution avec des fixtures pour attester les fonctionnement des tests sans cr√©er de sur consommation de ressources (alternative syst√©matique avec fallback)

#### Justification

- S√ªret√©: les tests restent strictement conformes aux sch√©mas; tra√ßabilit√© inchang√©e.
- Durabilit√©: supprime les recherches/fallbacks redondants (√©conomie CPU/IO).
- Gouvernance: distingue explicitement les jeux d‚Äôattestation (`__tests__/fixtures/...`) des donn√©es ‚Äúr√©elles‚Äù (`shared/.../data/`) par configuration, pas par heuristique.

#### Patterns valid√©s

- R√©pertoire unique pilot√© par `artifactBaseDir`.
- Sidecar d‚Äôapprobation adjacent et r√©solu depuis le m√™me r√©pertoire.
- Override optionnel via variable d‚Äôenvironnement `HERMES_CONCEPTS_ARTIFACT_DIR` (si pr√©sent, prioritaire sur `artifactBaseDir`).

#### Anti-Patterns (√† √©viter)

- Recherche multi-emplacements implicite (fixtures ‚Üí shared) dans le code des steps.
- D√©nominations sp√©ciales dans les noms de fichiers (la distinction se fait par le r√©pertoire).
- Couplage fort aux chemins en dur dans les steps.

#### √âtat d'impl√©mentation

üöß √Ä impl√©menter dans les steps BDD et la configuration

### Format du template NuExtract g√©n√©r√© par l'API

#### Description d√©taill√©e pour le format du template NuExtract

- [2025-10-21] L'API `/api/infer-template-async` transforme un sch√©ma JSON Schema en template NuExtract avec des r√®gles de conversion sp√©cifiques
- [2025-10-21] __Fixture de r√©f√©rence__ : Template valide obtenu de la plateforme SaaS disponible dans `__tests__/fixtures/nuextract-template-valid.json`
- [2025-10-21] __Types de base__ : `"type": "string"` ‚Üí `"string"`, `"type": "string", "pattern": "..."` ‚Üí `"verbatim-string"`, `"type": "string", "format": "date"` ‚Üí `"date-time"`
- [2025-10-21] __√ânum√©rations__ : Les `enum` JSON Schema sont converties en __tableaux__ dans le template NuExtract (ex: `"enum": ["de", "fr", "it", "en"]` ‚Üí `["de", "fr", "it", "en"]`)
- [2025-10-21] __Tableaux__ : Les `"type": "array"` JSON Schema sont repr√©sent√©s avec __un seul √©l√©ment type__ dans le template
- [2025-10-21] __R√©f√©rences $ref__ : Les r√©f√©rences sont __r√©solues et int√©gr√©es__ dans le template final (pas de `$ref` dans le template NuExtract)

#### Justification pour le format du template NuExtract

- __Interop√©rabilit√©__ : Format standardis√© NuExtract pour les extractions futures
- __Validation__ : Template valid√© par la plateforme SaaS garantit la conformit√©
- __Tests__ : Fixture de r√©f√©rence permet la validation automatis√©e des g√©n√©rations de template
- __Documentation par l'exemple__ : Template valide sert de r√©f√©rence pour comprendre les transformations

#### Patterns valid√©s pour le format du template NuExtract

- __Conversion √©num√©rations__ : `"language": {"type": "string", "enum": ["de", "fr", "it", "en"]}` ‚Üí `"language": ["de", "fr", "it", "en"]`
- __Types NuExtract__ : `"verbatim-string"` pour patterns, `"string"` pour texte libre, `"date-time"` pour dates
- __R√©solution r√©f√©rences__ : `"concept-phases": {"$ref": "./hermes2022-phases.json"}` ‚Üí structure compl√®te int√©gr√©e
- __Arrays template__ : `"phases": [{"id": "verbatim-string", "name": "string", ...}]` (un seul √©l√©ment type)
- __Fixture de test__ : `__tests__/fixtures/nuextract-template-valid.json` comme r√©f√©rence pour validation

#### Anti-Patterns pour le format du template NuExtract √† √©viter

- __$ref non r√©solues__ : √âviter de laisser des `$ref` dans le template ‚Üí __Solution__ : R√©soudre toutes les r√©f√©rences avant envoi √† l'API ‚Üí __R√®gle √† adopter__ : Utiliser le sch√©ma r√©solu complet
- __√ânum√©rations non converties__ : √âviter de tester avec `"enum": [...]` dans template ‚Üí __Solution__ : Valider que les √©num√©rations sont des tableaux ‚Üí __R√®gle √† adopter__ : Tests BDD v√©rifient la conversion
- __Structure array incorrecte__ : √âviter plusieurs √©l√©ments types dans array ‚Üí __Solution__ : Un seul √©l√©ment type ‚Üí __R√®gle √† adopter__ : Format NuExtract standard

#### √âtat d'impl√©mentation pour le format du template NuExtract

‚úÖ [Fixture valid√©e et tests adapt√©s]

- ‚úÖ __Fixture de r√©f√©rence__ : `__tests__/fixtures/nuextract-template-valid.json` cr√©√©e depuis plateforme SaaS
- ‚úÖ __Tests BDD am√©lior√©s__ : Validation de la structure, des √©num√©rations converties, des types NuExtract, et de la r√©solution des `$ref`
- üöß __API retourne template vide__ : Investigation en cours avec NuMind sur pourquoi l'API retourne `{}` alors que la plateforme SaaS fonctionne correctement

### Extraction de texte brut depuis HTML pour r√©duction de la taille du prompt

#### Description d√©taill√©e pour l'extraction de texte brut depuis HTML

- [2025-11-04] Les pages HTML extraites du site HERMES2022 sont converties en texte brut avant d'√™tre incluses dans le prompt envoy√© √† NuExtract pour r√©duire la taille du prompt et respecter la limite de 32768 tokens de l'API
- [2025-11-04] La biblioth√®que `html-to-text` est utilis√©e pour convertir le HTML en texte brut en conservant la structure s√©mantique (titres, listes, paragraphes) et en supprimant les balises HTML inutiles
- [2025-11-04] La conversion HTML‚Üítexte permet de r√©duire significativement la taille du prompt (ex: ~88 000 caract√®res HTML ‚Üí ~30 000 caract√®res texte) tout en pr√©servant l'information pertinente pour l'extraction IA
- [2025-11-04] La conversion est appliqu√©e apr√®s le fetch HTML et avant la construction du prompt d'extraction dans `buildExtractionPrompt()`

#### Justification pour l'extraction de texte brut depuis HTML

- __Limite de contexte NuExtract__ : L'API NuExtract a une limite stricte de 32768 tokens en entr√©e, ce qui est insuffisant pour les pages HTML compl√®tes (ex: 230 690 tokens avec HTML brut)
- __R√©duction de taille__ : La conversion HTML‚Üítexte r√©duit significativement la taille (suppression des balises, attributs, scripts, styles) tout en pr√©servant le contenu s√©mantique
- __Ad√©quation au cas d'usage__ : `html-to-text` est sp√©cifiquement con√ßu pour convertir HTML en texte lisible, exactement ce qui est n√©cessaire pour r√©duire la taille du prompt
- __Simplicit√©__ : Une seule fonction `htmlToText()` suffit pour convertir le HTML, pas besoin de manipulation DOM complexe
- __Qualit√© de sortie__ : La biblioth√®que pr√©serve la structure (titres, listes, paragraphes) et le formatage (espaces, sauts de ligne) pour maintenir la lisibilit√© par l'IA

#### Tableau comparatif : Cheerio vs html-to-text

| Crit√®re | Cheerio | html-to-text | D√©cision |
|:--------|:--------|:-------------|:---------|
| __Ad√©quation au cas d'usage__ | Biblioth√®que g√©n√©rale manipulation DOM (style jQuery) | Sp√©cifiquement con√ßu pour HTML‚Üítexte | ‚úÖ __html-to-text__ (objectif exact) |
| __Simplicit√© d'impl√©mentation__ | N√©cessite s√©lection CSS et extraction manuelle texte | Fonction unique `htmlToText(html)` | ‚úÖ __html-to-text__ (1 ligne vs code custom) |
| __Performance__ | Rapide (parser l√©ger) | Rapide (optimis√© pour conversion) | ‚öñÔ∏è √âquivalent |
| __Taille biblioth√®que__ | ~50KB (d√©pendances jQuery-like) | ~30KB (l√©g√®rement plus petit) | ‚öñÔ∏è √âquivalent |
| __Maintenance__ | Tr√®s active (50M t√©l√©chargements/semaine) | Active (5M t√©l√©chargements/semaine) | ‚öñÔ∏è Les deux bien maintenus |
| __Flexibilit√©__ | Tr√®s flexible (manipulation DOM compl√®te) | Focus conversion HTML‚Üítexte | ‚öñÔ∏è Flexibilit√© non n√©cessaire |
| __Qualit√© de sortie__ | Formatage manuel (d√©pend de l'impl√©mentation) | Formatage optimis√© (titres, listes, paragraphes) | ‚úÖ __html-to-text__ (formatage sp√©cialis√©) |
| __D√©pendances__ | jsdom (parser HTML) | Aucune d√©pendance lourde | ‚úÖ __html-to-text__ (plus l√©ger) |
| __Cas d'usage__ | Web scraping, manipulation DOM | Conversion HTML‚Üítexte, emails | ‚úÖ __html-to-text__ (cas d'usage exact) |

__Conclusion__ : `html-to-text` est plus adapt√© car il est sp√©cifiquement con√ßu pour la conversion HTML‚Üítexte, ce qui correspond exactement au besoin (r√©duction de taille du prompt tout en pr√©servant le contenu s√©mantique).

#### Patterns valid√©s pour l'extraction de texte brut depuis HTML

- __Installation__ : `npm install --save-dev html-to-text`
- __Import__ : `const { convert } = require('html-to-text')`
- __Conversion HTML‚Üítexte__ : `const textContent = convert(htmlContent, { wordwrap: false, preserveNewlines: true })`
- __Options de conversion__ :
  - `wordwrap: false` : Pas de limitation de longueur de ligne (√©vite la troncature)
  - `preserveNewlines: true` : Pr√©serve les sauts de ligne pour maintenir la structure
- __Int√©gration dans fetchHtmlContent__ : Conversion apr√®s fetch HTML et avant retour dans `fetchHtmlContent()`
- __Int√©gration dans buildExtractionPrompt__ : Le texte brut est utilis√© directement dans la construction du prompt

#### Anti-Patterns pour l'extraction de texte brut depuis HTML √† √©viter

- __Utiliser Cheerio pour conversion__ : √âviter d'utiliser Cheerio pour extraire le texte manuellement ‚Üí __Solution__ : Utiliser `html-to-text` ‚Üí __R√®gle √† adopter__ : Biblioth√®que sp√©cialis√©e pour conversion HTML‚Üítexte
- __Envoyer HTML brut__ : √âviter d'envoyer le HTML brut √† NuExtract ‚Üí __Solution__ : Toujours convertir en texte brut ‚Üí __R√®gle √† adopter__ : Conversion syst√©matique pour respecter limite tokens
- __Options de conversion trop restrictives__ : √âviter `wordwrap: 80` qui peut tronquer le contenu ‚Üí __Solution__ : `wordwrap: false` pour pr√©server le contenu complet ‚Üí __R√®gle √† adopter__ : Pr√©server le contenu s√©mantique
- __Conversion tardive__ : √âviter de convertir apr√®s agr√©gation de tous les blocs ‚Üí __Solution__ : Convertir imm√©diatement apr√®s fetch HTML ‚Üí __R√®gle √† adopter__ : Conversion d√®s r√©ception HTML

#### √âtat d'impl√©mentation pour l'extraction de texte brut depuis HTML

üöß [D√©cision document√©e - 2025-11-04]

- üöß __Installation__ : `html-to-text` √† installer dans `package.json`
- üöß __Int√©gration__ : Fonction `fetchHtmlContent()` √† modifier pour convertir HTML‚Üítexte
- üöß __Tests BDD__ : Tests √† adapter pour valider la conversion HTML‚Üítexte
